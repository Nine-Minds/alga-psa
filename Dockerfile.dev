FROM node:alpine

RUN apk add --no-cache \
    bash \
    curl \
    ghostscript \
    graphicsmagick \
    imagemagick \
    postgresql-client \
    redis

WORKDIR /app

# Copy manifests first for better layer caching
COPY package.json package-lock.json ./
COPY server/package.json ./server/
COPY shared/package.json ./shared/
COPY services/workflow-worker/package.json ./services/workflow-worker/
COPY ee/server/package.json ./ee/server/
COPY packages ./packages
COPY sdk ./sdk

RUN npm config set legacy-peer-deps true && npm install

# Bring in source (server, shared, ee, etc.)
COPY . .

ENV NODE_OPTIONS="--max-old-space-size=8192"
COPY server/dev-entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 3000
ENV NODE_ENV=development

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
