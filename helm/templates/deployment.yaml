{{- if and (not .Values.devEnv.enabled) (not .Values.hostedEnv.enabled) }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "sebastian.fullname" . }}
  namespace: {{ include "sebastian.namespace" . }}
  labels:
    {{- include "sebastian.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.server.replicaCount }}
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "sebastian.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if .Values.vaultAgent.enabled }}
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "{{ .Values.vaultAgent.role }}"
        vault.hashicorp.com/agent-inject-secret-alga_auth_key: "{{ .Values.vaultAgent.sharedSecretPath }}"
        vault.hashicorp.com/agent-inject-template-alga_auth_key: |
          {{`{{- with secret "`}}{{ .Values.vaultAgent.sharedSecretPath }}{{`" -}}
          {{- .Data.data.alga_auth_key -}}
          {{- end }}`}}        
        vault.hashicorp.com/agent-inject-secret-server-secrets: "{{ .Values.vaultAgent.secretPath }}"
        vault.hashicorp.com/agent-inject-template-server-secrets: |
          {{`{{- with secret "`}}{{ .Values.vaultAgent.secretPath }}{{`" -}}
          {{- range $k, $v := .Data.data -}}
          export {{ $k }}="{{ $v }}"
          {{- end -}}
          {{- end }}`}}
        # Fix for Vault + Istio compatibility - exclude Vault traffic from Istio proxy
        {{- with .Values.istio.sidecar.excludeOutboundPorts }}
        traffic.sidecar.istio.io/excludeOutboundPorts: "{{ join "," . }}"
        {{- end }}
        {{- with .Values.istio.sidecar.excludeOutboundIPRanges }}
        traffic.sidecar.istio.io/excludeOutboundIPRanges: "{{ . }}"
        {{- end }}
        {{- with .Values.istio.sidecar.includeOutboundIPRanges }}
        traffic.sidecar.istio.io/includeOutboundIPRanges: "{{ . }}"
        {{- end }}
        {{- end }}
      labels:
        {{- include "sebastian.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: "main"
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:    
      {{- if .Values.server.image.is_private }}
      imagePullSecrets:
        - name: "{{ .Values.server.image.credentials }}"
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      volumes:
        {{- /* Only mount storage volume when using local storage (S3 not enabled) */}}
        {{- if and .Values.server.persistence.enabled (not .Values.config.storage.providers.s3.enabled) }}
        - name: storage-volume
          {{- if .Values.server.persistence.existingClaim }}
          persistentVolumeClaim:
            claimName: {{ .Values.server.persistence.existingClaim }}
          {{- else }}
          persistentVolumeClaim:
            claimName: {{ include "sebastian.fullname" . }}-storage
          {{- end }}
        {{- end }}        
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.server.image.name }}:{{ .Values.server.image.tag }}"
          command: ["./entrypoint.sh"]
          imagePullPolicy: {{ .Values.server.pullPolicy }}
          env:
          # ----------- EDITION ----------------
          - name: NEXT_PUBLIC_EDITION
            value: "{{ .Values.edition | default "community" }}"
          - name: EDITION
            value: "{{ .Values.edition | default "community" }}"
          # ----------- APP ----------------
          - name: VERSION
            value: "{{ .Values.version }}"
          - name: APP_VERSION
            value: "{{ .Values.version }}"
          - name: NEXT_PUBLIC_APP_VERSION
            value: "{{ .Values.version }}"
          - name: APP_BUILD_SHA
            value: "{{ .Values.build.sha | default .Values.server.image.tag }}"
          - name: NEXT_PUBLIC_APP_BUILD_SHA
            value: "{{ .Values.build.sha | default .Values.server.image.tag }}"
          - name: APP_NAME
            value: "{{ .Values.nameOverride }}"
          - name: APP_ENV
            value: "{{ .Values.env }}"
          - name: NODE_ENV
            value: "{{ .Values.env }}"
          - name: HOST
            value: "{{ include "sebastian.resolveHost" . }}"
          - name: VERIFY_EMAIL_ENABLED
            value: "{{ .Values.server.verify_email}}"

          # ----------- TEMPORAL ----------------
          - name: TEMPORAL_ADDRESS
            value: "{{ .Values.temporal.address }}"
          - name: TEMPORAL_NAMESPACE
            value: "{{ .Values.temporal.namespace }}"
          - name: TEMPORAL_PORTAL_DOMAIN_TASK_QUEUE
            value: "{{ .Values.temporal.portalDomainTaskQueue }}"

          # ----------- REDIS ----------------
          {{- if .Values.redis.enabled }}
          - name: REDIS_HOST
            value: "redis.{{ include "sebastian.namespace" . }}.svc.cluster.local"
          - name: REDIS_PORT
            value: "6379"
          - name: REDIS_DB
            value: "0"
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: redis-credentials
                key: REDIS_PASSWORD
          {{- else }}
          - name: REDIS_HOST
            value: "{{ .Values.config.redis.host }}.{{ include "sebastian.namespace" . }}.svc.cluster.local"
          - name: REDIS_PORT
            value: "{{ .Values.config.redis.port }}"
          - name: REDIS_DB
            value: "{{ .Values.config.redis.db }}"
          - name: REDIS_PASSWORD
            {{- if and .Values.config.redis.passwordSecret.name .Values.config.redis.passwordSecret.key }}
            valueFrom:
              secretKeyRef:
                name: {{ .Values.config.redis.passwordSecret.name | quote }}
                key: {{ .Values.config.redis.passwordSecret.key | quote }}
            {{- else }}
            value: {{ .Values.config.redis.password | quote }}
            {{- end }}
          {{- end }}

          # ----------- HOCUSPOCUS ----------------
          {{- if or .Values.hocuspocus.enabled (not .Values.hostedEnv.enabled) }}
          - name: REQUIRE_HOCUSPOCUS
            value: "true"
          - name: HOCUSPOCUS_HOST
            value: "hocuspocus.{{ include "sebastian.namespace" . }}.svc.cluster.local"
          - name: HOCUSPOCUS_PORT
            value: "{{ .Values.hocuspocus.service.port | default 1234 }}"
          - name: NEXT_PUBLIC_HOCUSPOCUS_URL
            value: "wss://{{ include "sebastian.resolveHost" . }}/hocuspocus"
          {{- end }}

          # ----------- DB ----------------
          {{- if .Values.db.enabled }}
          - name: DB_TYPE
            value: "postgres"
          - name: DB_HOST
            value: "db.{{ include "sebastian.namespace" . }}.svc.cluster.local"
          - name: DB_USER_SERVER
            value: "app_user"
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME_SERVER
            value: "server"
          - name: DB_USER_ADMIN
            value: "postgres"
          - name: DB_PASSWORD_ADMIN
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: DB_PASSWORD_SUPERUSER
          - name: DB_PASSWORD_SUPERUSER
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: DB_PASSWORD_SUPERUSER                
          - name: DB_PASSWORD_SERVER
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: DB_PASSWORD_SERVER
          {{- else }}
          - name: DB_TYPE
            value: "postgres"          
          - name: DB_HOST
            value: "{{ .Values.config.db.host }}"
          - name: DB_USER_SERVER
            value: "{{ .Values.config.db.user }}"          
          - name: DB_USER_ADMIN
            value: "postgres"
          - name: DB_PORT
            value: "{{ .Values.config.db.port }}"
          - name: DB_NAME_SERVER
            value: "{{ .Values.config.db.server_database }}"
          - name: DB_PASSWORD_ADMIN
            {{- with .Values.config.db.server_password_admin_secret }}
            valueFrom:
              secretKeyRef:
                name: {{ .name | quote }}
                key: {{ .key | quote }}
            {{- else }}
            value: {{ .Values.config.db.server_admin_password | quote }}
            {{- end }}
          - name: DB_PASSWORD_SERVER
            {{- with .Values.config.db.server_password_secret }}
            valueFrom:
              secretKeyRef:
                name: {{ .name | quote }}
                key: {{ .key | quote }}
            {{- else }}
            value: {{ .Values.config.db.server_password | quote }}
            {{- end }}
          {{- end }}

          # ----------- STORAGE ----------------
          # Local Storage Provider (Community Edition)
          {{- if not .Values.config.storage.providers.s3.enabled }}
          - name: STORAGE_DEFAULT_PROVIDER
            value: "local"
          - name: STORAGE_LOCAL_BASE_PATH
            value: "{{ .Values.config.storage.providers.local.base_path | default "/data/files" }}"
          - name: STORAGE_LOCAL_MAX_FILE_SIZE
            value: "{{ .Values.config.storage.providers.local.max_file_size | default 104857600 }}"
          - name: STORAGE_LOCAL_ALLOWED_MIME_TYPES
            value: "{{ join "," .Values.config.storage.providers.local.allowed_mime_types | default "image/*,application/pdf,text/plain" }}"
          - name: STORAGE_LOCAL_RETENTION_DAYS
            value: "{{ .Values.config.storage.providers.local.retention_days | default "30" }}"
          {{- end }}

          # S3 Storage Provider (Enterprise Edition)
          {{- if .Values.config.storage.providers.s3.enabled }}
          - name: STORAGE_DEFAULT_PROVIDER
            value: "s3"
          - name: STORAGE_S3_REGION
            value: "{{ .Values.config.storage.providers.s3.region }}"
          - name: STORAGE_S3_BUCKET
            value: "{{ .Values.config.storage.providers.s3.bucket }}"
          {{- if .Values.config.storage.providers.s3.bundle_bucket }}
          - name: STORAGE_S3_BUNDLE_BUCKET
            value: "{{ .Values.config.storage.providers.s3.bundle_bucket }}"
          {{- end }}
          - name: STORAGE_S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.config.storage.providers.s3.secretRef.name | default "storage-credentials" | quote }}
                key: {{ .Values.config.storage.providers.s3.secretRef.accessKeyKey | default "S3_ACCESS_KEY" | quote }}
          - name: STORAGE_S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.config.storage.providers.s3.secretRef.name | default "storage-credentials" | quote }}
                key: {{ .Values.config.storage.providers.s3.secretRef.secretKeyKey | default "S3_SECRET_KEY" | quote }}
          {{- if .Values.config.storage.providers.s3.endpoint }}
          - name: STORAGE_S3_ENDPOINT
            value: "{{ .Values.config.storage.providers.s3.endpoint }}"
          {{- end }}
          - name: STORAGE_S3_MAX_FILE_SIZE
            value: "{{ .Values.config.storage.providers.s3.max_file_size | default "104857600" }}"
          - name: STORAGE_S3_ALLOWED_MIME_TYPES
            value: "{{ join "," .Values.config.storage.providers.s3.allowed_mime_types | default "image/*,application/pdf,text/plain" }}"
          - name: STORAGE_S3_RETENTION_DAYS
            value: "{{ .Values.config.storage.providers.s3.retention_days | default "30" }}"
          {{- end }}

          # ----------- STORAGE UPLOAD ----------------
          - name: STORAGE_UPLOAD_TEMP_DIR
            value: "{{ .Values.config.storage.upload.temp_dir }}"
          - name: STORAGE_UPLOAD_MAX_CONCURRENT
            value: "{{ .Values.config.storage.upload.max_concurrent }}"
          - name: STORAGE_UPLOAD_CHUNK_SIZE
            value: "{{ .Values.config.storage.upload.chunk_size }}"

          # ----------- STORAGE BACKUP ----------------
          {{- if .Values.config.storage.backup.enabled }}
          - name: STORAGE_BACKUP_ENABLED
            value: "true"
          - name: STORAGE_BACKUP_SCHEDULE
            value: "{{ .Values.config.storage.backup.schedule }}"
          - name: STORAGE_BACKUP_RETENTION_DAYS
            value: "{{ .Values.config.storage.backup.retention.days }}"
          - name: STORAGE_BACKUP_RETENTION_COPIES
            value: "{{ .Values.config.storage.backup.retention.copies }}"
          {{- end }}

          # ----------- LOGGING ----------------
          - name: LOG_LEVEL
            value: "{{ .Values.logging.level }}"
          - name: LOG_IS_FORMAT_JSON
            value: "{{ .Values.logging.is_format_json }}"
          - name: LOG_IS_FULL_DETAILS
            value: "{{ .Values.logging.is_full_details }}"
          - name: LOG_ENABLED_FILE_LOGGING
            value: "{{ .Values.logging.file.enabled }}"
          - name: LOG_DIR_PATH
            value: "{{ .Values.logging.file.path }}"
          - name: LOG_ENABLED_EXTERNAL_LOGGING
            value: "{{ .Values.logging.external.enabled }}"
          - name: LOG_EXTERNAL_HTTP_HOST
            value: "{{ .Values.logging.external.host }}"
          - name: LOG_EXTERNAL_HTTP_PORT
            value: "{{ .Values.logging.external.port }}"
          - name: LOG_EXTERNAL_HTTP_PATH
            value: "{{ .Values.logging.external.path }}"
          - name: LOG_EXTERNAL_HTTP_LEVEL
            value: "{{ .Values.logging.external.level }}"
          - name: LOG_EXTERNAL_HTTP_TOKEN
            value: "{{ .Values.logging.external.token }}"

          # ----------- HOCUSPOCUS ----------------
          - name: HOCUSPOCUS_URL
            value: "ws://hocuspocus.{{ include "sebastian.namespace" . }}.svc.cluster.local:{{ .Values.hocuspocus.service.port }}"

          # ----------- EMAIL ----------------
          - name: EMAIL_ENABLE
            value: "{{ .Values.email.enabled }}"
          - name: EMAIL_FROM
            value: "{{ .Values.email.from }}"
          - name: EMAIL_HOST
            value: "{{ .Values.email.host }}"
          - name: EMAIL_PORT
            value: "{{ .Values.email.port }}"
          - name: EMAIL_USERNAME
            value: "{{ .Values.email.user }}"
          - name: EMAIL_PASSWORD
            value: "{{ .Values.email.password }}"
          # Optional: Explicit provider type. If omitted, factory auto-detects 'resend' by RESEND_API_KEY
          {{- if .Values.email.provider }}
          - name: EMAIL_PROVIDER_TYPE
            value: "{{ .Values.email.provider }}"
          {{- end }}
          # RESEND configuration (preferred for system emails). Use secret if available, else value.
          {{- if and .Values.email.resendApiKeySecret.name .Values.email.resendApiKeySecret.key }}
          - name: RESEND_API_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.email.resendApiKeySecret.name | quote }}
                key: {{ .Values.email.resendApiKeySecret.key | quote }}
          {{- else if .Values.email.resendApiKey }}
          - name: RESEND_API_KEY
            value: "{{ .Values.email.resendApiKey }}"
          {{- end }}
          {{- if .Values.email.resendBaseUrl }}
          - name: RESEND_BASE_URL
            value: "{{ .Values.email.resendBaseUrl }}"
          {{- end }}

          # ----------- LLM ----------------
          - name: OPENAI_API_KEY
            value: "{{ .Values.config.llm.openai }}"
          - name: ANTHROPIC_API_KEY
            value: "{{ .Values.config.llm.anthropic }}"

          # ----------- CRYPTO ----------------
          - name: CRYPTO_KEY
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: CRYPTR_KEY
          - name: SALT_BYTES
            value: "{{ .Values.crypto.salt_bytes }}"
          - name: ITERATIONS
            value: "{{ .Values.crypto.iteration }}"
          - name: KEY_LENGTH
            value: "{{ .Values.crypto.key_length }}"
          - name: ALGORITHM
            value: "{{ .Values.crypto.algorithm }}"
          - name: ALGA_AUTH_KEY
            valueFrom:
              secretKeyRef:
                name: alga-psa-shared
                key: ALGA_AUTH_KEY
          - name: SECRET_KEY
            value: "{{ .Values.crypto.secret_key }}"
            
          # ----------- TOKEN ----------------
          - name: TOKEN_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: TOKEN_SECRET_KEY
          - name: TOKEN_EXPIRE  
            value: "{{ .Values.token.expire }}"

          # ----------- AUTH ----------------
          # NEXTAUTH_URL is configured via .env file to allow dynamic updates during port forwarding
          - name: NEXTAUTH_URL
            value: "https://{{ .Values.host }}"
          # Public base URL for links in emails and client-side code
          - name: NEXT_PUBLIC_BASE_URL
            value: "https://{{ .Values.host }}"
          # App URL for Stripe redirects (can differ from host for blue/green testing)
          - name: NEXT_PUBLIC_APP_URL
            value: "https://{{ .Values.appUrl | default .Values.host }}"
          - name: NEXTAUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: NEXTAUTH_SECRET
          - name: NEXTAUTH_SESSION_EXPIRES
            value: "{{ .Values.auth.nextauth_session_expires }}"

          # ----------- EXTENSIONS ----------------
          {{- with .Values.config.extensions.domainRoot }}
          - name: EXT_DOMAIN_ROOT
            value: "{{ . }}"
          {{- end }}

          # ----------- RUNNER / EXTENSION EXECUTION -----------
          {{- with .Values.runner }}
          {{- $runnerBaseUrl := .baseUrl | default (printf "http://runner-exec.%s.svc.cluster.local" $.Release.Namespace) }}
          - name: RUNNER_BASE_URL
            value: "{{ $runnerBaseUrl }}"
          {{- if and .serviceTokenSecret (hasKey .serviceTokenSecret "name") (hasKey .serviceTokenSecret "key") (.serviceTokenSecret.name) (.serviceTokenSecret.key) }}
          - name: RUNNER_SERVICE_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ .serviceTokenSecret.name | quote }}
                key: {{ .serviceTokenSecret.key | quote }}
          {{- else if .serviceToken }}
          - name: RUNNER_SERVICE_TOKEN
            value: "{{ .serviceToken }}"
          {{- end }}
          {{- if .debugStream }}
          {{- if and .debugStream.redisUrlSecret (hasKey .debugStream.redisUrlSecret "name") (hasKey .debugStream.redisUrlSecret "key") (.debugStream.redisUrlSecret.name) (.debugStream.redisUrlSecret.key) }}
          - name: RUNNER_DEBUG_REDIS_URL
            valueFrom:
              secretKeyRef:
                name: {{ .debugStream.redisUrlSecret.name | quote }}
                key: {{ .debugStream.redisUrlSecret.key | quote }}
          {{- else if .debugStream.redisUrl }}
          - name: RUNNER_DEBUG_REDIS_URL
            value: "{{ .debugStream.redisUrl }}"
          {{- end }}
          {{- if .debugStream.streamPrefix }}
          - name: RUNNER_DEBUG_REDIS_STREAM_PREFIX
            value: "{{ .debugStream.streamPrefix }}"
          {{- end }}
          {{- if .debugStream.maxLen }}
          - name: RUNNER_DEBUG_REDIS_MAXLEN
            value: "{{ .debugStream.maxLen }}"
          {{- end }}
          {{- end }}
          {{- end }}

          # ----------- GOOGLE AUTH ----------------
          {{- with include "sebastian.googleOAuthEnv" . }}
{{ . | nindent 10 }}
          {{- end }}

          # ----------- GMAIL INTEGRATION ----------------
          {{- if .Values.gmail_integration.enabled }}
          - name: GOOGLE_CLIENT_ID
            value: "{{ .Values.gmail_integration.client_id }}"
          - name: GOOGLE_CLIENT_SECRET
            value: "{{ .Values.gmail_integration.client_secret }}"
          - name: GOOGLE_PROJECT_ID
            value: "{{ .Values.gmail_integration.project_id }}"
          {{- if .Values.gmail_integration.redirect_uri }}
          - name: GOOGLE_REDIRECT_URI
            value: "{{ .Values.gmail_integration.redirect_uri }}"
          {{- end }}
          {{- end }}

          # ----------- NM-STORE INTEGRATION ----------------
          {{- if .Values.nm_store_integration }}
          {{- if .Values.nm_store_integration.url }}
          - name: NM_STORE_URL
            value: "{{ .Values.nm_store_integration.url }}"
          {{- end }}
          {{- if .Values.nm_store_integration.use_shared_secret }}
          - name: TEMPORAL_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: nm-store-db-secret
                key: TEMPORAL_WEBHOOK_SECRET
          - name: ALGA_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: nm-store-db-secret
                key: ALGA_WEBHOOK_SECRET
          {{- end }}
          {{- end }}

          # ----------- MICROSOFT INTEGRATION ----------------
          {{- if .Values.microsoft_integration.enabled }}
          {{- if .Values.microsoft_integration.client_id }}
          - name: MICROSOFT_CLIENT_ID
            value: "{{ .Values.microsoft_integration.client_id }}"
          {{- end }}
          {{- if .Values.microsoft_integration.client_secret }}
          - name: MICROSOFT_CLIENT_SECRET
            value: "{{ .Values.microsoft_integration.client_secret }}"
          {{- end }}
          {{- if .Values.microsoft_integration.tenant_id }}
          - name: MICROSOFT_TENANT_ID
            value: "{{ .Values.microsoft_integration.tenant_id }}"
          {{- end }}
          {{- if .Values.microsoft_integration.redirect_uri }}
          - name: MICROSOFT_REDIRECT_URI
            value: "{{ .Values.microsoft_integration.redirect_uri }}"
          {{- end }}
          {{- with include "sebastian.microsoftOAuthEnv" . }}
{{ . | nindent 10 }}
          {{- end }}
          {{- end }}

          # ----------- XERO INTEGRATION ----------------
          {{- if .Values.xero_integration.enabled }}
          {{- if .Values.xero_integration.client_id }}
          - name: XERO_CLIENT_ID
            value: "{{ .Values.xero_integration.client_id }}"
          {{- end }}
          # XERO_CLIENT_SECRET is resolved via the secret provider chain:
          # 1. Vault (if configured in secrets_provider.readChain)
          # 2. Filesystem secrets (Docker secrets at /run/secrets/xero_client_secret)
          # 3. Environment variable XERO_CLIENT_SECRET
          # The application's secret provider will automatically resolve it.
          # Note: XERO_REDIRECT_URI is now derived from APP_BASE_URL in the application code
          {{- end }}

          # ----------- STRIPE INTEGRATION ----------------
          # Sensitive keys (read from secrets via secret provider)
          {{- if .Values.secrets.stripe_secret_key }}
          - name: STRIPE_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: stripe_secret_key
          {{- end }}
          {{- if .Values.secrets.stripe_publishable_key }}
          - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: stripe_publishable_key
          {{- end }}
          {{- if .Values.secrets.stripe_webhook_secret }}
          - name: STRIPE_WEBHOOK_SECRET
            valueFrom:
              secretKeyRef:
                name: "{{include "sebastian.fullname" .}}-secrets"
                key: stripe_webhook_secret
          {{- end }}

          # Non-sensitive Stripe configuration
          {{- if .Values.stripe }}
          {{- if .Values.stripe.master_billing_tenant_id }}
          - name: MASTER_BILLING_TENANT_ID
            value: "{{ .Values.stripe.master_billing_tenant_id }}"
          {{- end }}
          {{- if .Values.stripe.license_product_id }}
          - name: STRIPE_LICENSE_PRODUCT_ID
            value: "{{ .Values.stripe.license_product_id }}"
          {{- end }}
          {{- if .Values.stripe.license_price_id }}
          - name: STRIPE_LICENSE_PRICE_ID
            value: "{{ .Values.stripe.license_price_id }}"
          {{- end }}
          {{- end }}

          # ----------- SECRET PROVIDER ----------------
          # Composite secret provider configuration
          - name: SECRET_READ_CHAIN
            value: "{{ .Values.secrets_provider.readChain | default "env,filesystem" }}"
          - name: SECRET_WRITE_PROVIDER
            value: "{{ .Values.secrets_provider.writeProvider | default "filesystem" }}"
          {{- if .Values.secrets_provider.envPrefix }}
          - name: SECRET_ENV_PREFIX
            value: "{{ .Values.secrets_provider.envPrefix }}"
          {{- end }}
          
          # Vault configuration (only if vault is used)
          {{- if or (contains "vault" .Values.secrets_provider.readChain) (eq .Values.secrets_provider.writeProvider "vault") }}
          {{- if .Values.secrets_provider.vault.addr }}
          - name: VAULT_ADDR
            value: "{{ .Values.secrets_provider.vault.addr }}"
          {{- end }}
          {{- if or .Values.secrets_provider.vault.token (or (contains "vault" .Values.secrets_provider.readChain) (eq .Values.secrets_provider.writeProvider "vault")) }}
          - name: VAULT_TOKEN
            {{- if .Values.secrets_provider.vault.token }}
            value: "{{ .Values.secrets_provider.vault.token }}"
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: vault-credentials
                key: VAULT_TOKEN
            {{- end }}
          {{- end }}
          {{- if .Values.secrets_provider.vault.appSecretPath }}
          - name: VAULT_APP_SECRET_PATH
            value: "{{ .Values.secrets_provider.vault.appSecretPath }}"
          {{- end }}
          {{- if .Values.secrets_provider.vault.tenantSecretPathTemplate }}
          - name: VAULT_TENANT_SECRET_PATH_TEMPLATE
            value: "{{ .Values.secrets_provider.vault.tenantSecretPathTemplate }}"
          {{- end }}
          {{- end }}
         {{- if and .Values.server.persistence.enabled (not .Values.config.storage.providers.s3.enabled) }}
          volumeMounts:
            - name: storage-volume
              mountPath: {{ .Values.server.persistence.mountPath }}
          {{- end }}
          ports:
            - name: http
              containerPort: {{ .Values.server.service.port }}
              protocol: TCP
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
