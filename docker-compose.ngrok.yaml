# Modular ngrok tunnel for webhook testing
# Works with any Alga PSA worktree without modification
#
# Usage: Add this file to your compose chain:
#   docker compose -f docker-compose.yaml -f docker-compose.base.yaml -f docker-compose.ee.yaml -f docker-compose.ngrok.yaml up -d
#
# The ngrok dashboard is available at http://localhost:${NGROK_DASHBOARD_PORT:-4040}
# The ngrok URL is written to /app/ngrok/url inside the server container
#
# To check the current ngrok URL:
#   docker compose logs ngrok-sync | grep "Public URL"
#   - OR -
#   curl -s http://localhost:${NGROK_DASHBOARD_PORT:-4040}/api/tunnels | jq -r '.tunnels[0].public_url'
#
# Prerequisites:
#   1. Create ./secrets/ngrok_authtoken with your ngrok auth token
#      Get one at: https://dashboard.ngrok.com/get-started/your-authtoken

volumes:
  ngrok-data:
    name: ${COMPOSE_PROJECT_NAME:-alga}_ngrok_data

services:
  ngrok:
    image: ngrok/ngrok:latest
    restart: unless-stopped
    networks:
      - app-network
    ports:
      - "${NGROK_DASHBOARD_PORT:-4040}:4040"
    volumes:
      - ./secrets/ngrok_authtoken:/run/secrets/ngrok_authtoken:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        export NGROK_AUTHTOKEN=$$(cat /run/secrets/ngrok_authtoken)
        while true; do
          echo "[ngrok] Starting tunnel to server:3000..."
          ngrok http http://server:3000 --log=stdout && break
          echo "[ngrok] Exited, retrying in 10 seconds..."
          sleep 10
        done
    depends_on:
      - server
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4040/api/tunnels"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  ngrok-sync:
    image: alpine:latest
    restart: unless-stopped
    networks:
      - app-network
    volumes:
      - ngrok-data:/ngrok:rw
    depends_on:
      ngrok:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache wget jq

        LAST_URL=""

        echo "[ngrok-sync] Waiting for ngrok tunnel..."

        while true; do
          # Query ngrok API for current tunnel URL
          TUNNEL_RESPONSE=$$(wget -q -O - "http://ngrok:4040/api/tunnels" 2>/dev/null) || {
            echo "[ngrok-sync] Failed to reach ngrok API, retrying..."
            sleep 5
            continue
          }

          # Extract the https public URL (prefer https over http)
          PUBLIC_URL=$$(echo "$$TUNNEL_RESPONSE" | jq -r '[.tunnels[] | select(.proto == "https")] | .[0].public_url // .tunnels[0].public_url' 2>/dev/null)

          if [ -n "$$PUBLIC_URL" ] && [ "$$PUBLIC_URL" != "null" ]; then
            if [ "$$PUBLIC_URL" != "$$LAST_URL" ]; then
              echo "[ngrok-sync] âœ“ Public URL: $$PUBLIC_URL"

              # Write to shared volume
              echo "$$PUBLIC_URL" > /ngrok/url
              echo "$$(date -Iseconds)" > /ngrok/updated_at

              # Also create a sourceable env file
              cat > /ngrok/env <<EOF
        # Auto-generated by ngrok-sync at $$(date -Iseconds)
        NGROK_PUBLIC_URL=$$PUBLIC_URL
        NINJAONE_WEBHOOK_BASE_URL=$$PUBLIC_URL
        EOF

              LAST_URL="$$PUBLIC_URL"
            fi
          fi

          sleep 5
        done

  # Override server to mount the ngrok volume
  server:
    volumes:
      - ngrok-data:/app/ngrok:ro
