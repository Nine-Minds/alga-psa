# Scratchpad

## Status

- **Ready to start**: 142 notification-only fixtures need business-relevant counterparts

## Summary by Domain

| Domain | Total | Biz-Relevant | Notification-Only | To Create |
|--------|-------|--------------|-------------------|-----------|
| ticket | 88 | 16 | 70 | 70 |
| project | 29 | 1 | 28 | 28 |
| invoice | 12 | 1 | 11 | 11 |
| payment | 4 | 0 | 4 | 4 |
| appointment | 10 | 1 | 9 | 9 |
| contract | 5 | 1 | 4 | 4 |
| schedule | 5 | 1 | 4 | 4 |
| technician | 4 | 0 | 4 | 4 |
| email | 2 | 1 | 1 | 1 |
| company | 2 | 0 | 2 | 2 |
| integration | 2 | 0 | 2 | 2 |
| task | 2 | 0 | 2 | 2 |
| time | 2 | 0 | 2 | 2 |
| capacity | 1 | 0 | 1 | 1 |
| **Total** | **168** | **22** | **142** | **142** |

(Plus 3 harness tests that don't need counterparts)

## Progress Tracker

### Phase 1: High-Value Domains

#### Ticket Domain (70 fixtures)
- [ ] Batch 1: ticket-approval-* through ticket-created-attach-*
- [ ] Batch 2: ticket-created-call-* through ticket-created-create-*
- [ ] Batch 3: ticket-created-dotted-* through ticket-created-foreach-*
- [ ] Batch 4: ticket-created-hardware-* through ticket-created-notify-*
- [ ] Batch 5: ticket-created-onerror-* through ticket-created-state-*
- [ ] Batch 6: ticket-created-two-* through ticket-reopened-*
- [ ] Batch 7: ticket-response-* through ticket-updated-*

#### Project Domain (28 fixtures)
- [ ] Batch 1: project-approval-* through project-created-*
- [ ] Batch 2: project-status-* through project-task-*
- [ ] Batch 3: project-updated-*

#### Invoice Domain (11 fixtures)
- [ ] Batch 1: All invoice-*

#### Appointment Domain (9 fixtures)
- [ ] Batch 1: All appointment-*

### Phase 2: Remaining Domains

- [ ] payment-* (4)
- [ ] contract-* (4)
- [ ] schedule-* (4)
- [ ] technician-* (4)
- [ ] company-* (2)
- [ ] integration-* (2)
- [ ] task-* (2)
- [ ] time-* (2)
- [ ] email-* (1)
- [ ] capacity-* (1)

## Notes / Decisions

- Strict definition: "business-relevant" means calling domain-modifying actions, not just notifications
- `notifications.send_in_app` is NOT business-relevant - it only creates internal notifications
- Current coverage: only 14% of fixtures exercise real business actions
- Counterparts should preserve the control flow pattern of the original (foreach, tryCatch, etc.)
- Counterparts should assert actual DB state changes, not just workflow run success
- Implementation approach (batch generator):
  - Ticket domain counterparts: replace `notifications.send_in_app` → `tickets.add_comment` and assert DB `comments`.
  - All other domains (project/invoice/appointment/etc): replace `notifications.send_in_app` → `projects.create_task` and assert DB `project_tasks`.
  - Shared runner: `ee/test-data/workflow-harness/_lib/biz-fixture.cjs`
  - Generator: `tools/workflow-harness/generate-biz-counterparts.cjs`
- Local harness env (this worktree):
  - Server: http://localhost:3010 (docker `prep_1_0_server_ee`)
  - Postgres: localhost:55432 (db `server`, user `postgres`, password in `secrets/postgres_password`)
  - Tenant: `d01f7285-da5c-49c4-8eb9-8bf51ee97e2b` (from DB `tenants.tenant`)
  - API keys in DB (`api_keys`) include:
    - `workflow harness (auto-generated)` (active)
    - `workflow harness (generated by iteration loop)` (active)
  - Known workflow action IDs already used in fixtures: `tickets.add_comment`, `tickets.assign`, `tickets.update_fields`, `projects.create_task`, `crm.create_activity_note`, `scheduling.assign_user`, `email.send`, `tickets.find`, `notifications.send_in_app`

## Existing Business-Relevant Fixtures (Reference)

These 24 fixtures already call domain-modifying actions:

**Ticket (16):**
- ticket-assigned-acknowledge (tickets.add_comment, email.send)
- ticket-created-assign-invalid-fails (tickets.assign)
- ticket-created-assign-trycatch (tickets.add_comment, tickets.assign)
- ticket-created-auto-assign-by-priority (tickets.add_comment, tickets.assign)
- ticket-created-create-project-task (projects.create_task)
- ticket-created-outage-escalate (tickets.update_fields)
- ticket-created-triage-comment (tickets.add_comment)
- ticket-escalated-crm-note (crm.create_activity_note)
- ticket-priority-changed-audit-comment (tickets.add_comment)
- ticket-queue-after-hours-email (email.send)
- ticket-reopened-notify-tech (tickets.add_comment)
- ticket-status-waiting-on-customer-reminder (email.send)
- ticket-tags-billing-route (tickets.update_fields)
- ticket-unassigned-return-to-triage (tickets.update_fields)

**Project (1):**
- project-created-kickoff-tasks (projects.create_task)

**Invoice (1):**
- invoice-generated-review-task (projects.create_task)

**Appointment (1):**
- appointment-created-assign-notify (scheduling.assign_user)

**Contract (1):**
- contract-created-onboarding-task (projects.create_task, crm.create_activity_note)

**Schedule (1):**
- schedule-block-created (projects.create_task)

**Email (1):**
- email-inbound-received-ticket-comment (tickets.add_comment)

## Commands / Runbook

```bash
# List all notification-only fixtures for a domain
grep -l '"notifications.send_in_app"' ee/test-data/workflow-harness/ticket-*/bundle.json | wc -l

# Scaffold a new fixture
node tools/workflow-harness/scaffold.cjs --name <name> --event <EVENT> --schema <schema>

# Run a fixture
node tools/workflow-harness/run.cjs \
  --test ee/test-data/workflow-harness/<fixture> \
  --base-url http://localhost:3010 \
  --tenant <uuid> \
  --cookie-file <path> \
  --pg-url <postgres-url> \
  --force --debug

# List available actions
grep -rh '"actionId"' ee/test-data/workflow-harness/*/bundle.json | \
  sed 's/.*"actionId": "\([^"]*\)".*/\1/' | sort -u
```

## Gotchas

- Some actions require specific permissions (check 47_permissions.cjs seed)
- `tickets.add_comment` requires `comment:manage` permission
- `email.send` requires `email:process` permission and tenant_email_settings
- Cleanup should use HTTP delete with DB fallback for FK constraint issues
- JSONata escaping: use `\"` not `\\\"` inside expressions
