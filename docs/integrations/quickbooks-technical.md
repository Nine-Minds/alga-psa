# QuickBooks Online Integration – Technical Overview

## 1. Architecture Summary
QuickBooks Online (QBO) now plugs into Alga PSA through the shared **Accounting Export Service** and its adapter registry. The integration no longer depends on event-driven workflows or Automation Hub triggers. Instead, operators create and execute export batches manually from the Accounting Exports UI (or via API/CLI automation that calls the same services).

Key building blocks:
- **OAuth connection UI** (`/msp/settings?tab=integrations`) stores multi-realm QBO credentials. The callback (`server/src/app/api/integrations/qbo/callback/route.ts`) only persists tokens and redirects back to the UI.
- **Mapping manager** (`server/src/components/integrations/qbo/QboMappingManager.tsx`) reuses the generic accounting mapping components. Mappings live in `tenant_external_entity_mappings` and are resolved at export time.
- **Accounting Export Service** (`server/src/lib/services/accountingExportService.ts`) orchestrates batch creation, validation, execution, and status tracking. The service is adapter-agnostic and shared with Xero.
- **QuickBooks adapter** (`server/src/lib/adapters/accounting/quickBooksOnlineAdapter.ts`) formats canonical export documents and delivers them through `QboClientService`.
- **Export UI** (`server/src/components/billing-dashboard/accounting/AccountingExportsTab.tsx`) lets operators create batches, inspect validation results, and trigger delivery.

## 2. Export Flow
1. **Batch creation** – Operators filter invoices in the Accounting Exports UI (or `accountingExportActions.createAccountingExportBatch`) and choose adapter `quickbooks_online` plus the target realm.
2. **Validation** – `AccountingExportService` ensures required mappings exist (customers, services, taxes, payment terms). Missing mappings push the batch to `needs_attention` with error rows.
3. **Execution** – Once ready, `executeBatch` calls the QuickBooks adapter. The adapter:
   - loads invoices/charges/customers from the tenant database
   - resolves mappings via `AccountingMappingResolver`
   - builds QBO invoice payloads
   - uses `QboClientService` to create or update invoices, persisting sync tokens in the export mapping table.
4. **Status updates** – Delivered lines are marked in `accounting_export_lines`; the batch transitions to `delivered`. Failures bubble back as export errors for operator review.

Exports run synchronously from the user’s perspective, but the tables (`accounting_export_batches`, `accounting_export_lines`, `accounting_export_errors`) capture a full audit trail. Operators can rerun a batch after fixing mappings or data issues.

## 3. Entity Mapping
- Managed through the unified accounting mapping UI. QuickBooks modules are generated by `server/src/components/integrations/qbo/qboMappingModules.ts`.
- Mappings are stored in `tenant_external_entity_mappings` with optional metadata (e.g., sync tokens, sales terms).
- `AccountingMappingResolver` provides read-side resolution and ensures company mappings exist (creating them through `CompanyAccountingSyncService` when necessary).

## 4. Credential & Realm Management
- OAuth credentials are saved per tenant in the `qbo_credentials` secret. The secret holds multiple realms keyed by realm ID, enabling customers to connect more than one QBO company.
- `QboClientService` reads credentials, refreshes tokens when needed, and exposes helper methods for QBO API calls used by the accounting adapter (invoice create/update, customer lookup, etc.).
- Disconnect simply deletes credentials; no workflow attachments remain.

## 5. Adapter Responsibilities
- Implemented in `quickBooksOnlineAdapter.ts` and registered automatically by `AccountingAdapterRegistry`.
- `transform(context)` builds canonical invoice documents from `accounting_export_lines` and database lookups.
- `deliver(transformResult, context)` pushes invoices to QBO. Existing invoices are updated with sync tokens stored in mapping metadata; new invoices return IDs/sync tokens that are upserted into mapping records.
- Adapter capabilities: `deliveryMode = 'api'`, supports partial retry and invoice updates.

## 6. Error Handling & Operations
- Validation failures surface as batch errors before delivery. Operators resolve issues (usually missing mappings) and re-run the batch.
- Delivery errors return in the adapter result and are added to `accounting_export_errors`. Operators can correct data/mappings and re-execute the batch.
- No background workflows or Redis events fire for QuickBooks; monitoring focuses on accounting export batch states and adapter logs.

## 7. Relevant Files & Modules
- `server/src/lib/services/accountingExportService.ts`
- `server/src/lib/adapters/accounting/quickBooksOnlineAdapter.ts`
- `server/src/lib/qbo/qboClientService.ts`
- `server/src/components/integrations/qbo/QboMappingManager.tsx`
- `server/src/components/billing-dashboard/accounting/AccountingExportsTab.tsx`
- `server/src/lib/services/accountingMappingResolver.ts`
- `server/src/lib/actions/integrations/qboActions.ts` (connection status, lookup helpers)
- `server/src/app/api/integrations/qbo/callback/route.ts`

With the event-driven workflows removed, the QuickBooks integration now matches the Xero architecture: manual export orchestration, shared mapping + validation logic, and adapter-based delivery.
## 8. Legacy Cleanup
- Prior to deploying these changes in an environment that previously ran QBO workflows, cancel any in-flight `qboInvoiceSyncWorkflow` or `qboCustomerSyncWorkflow` executions in Automation Hub to avoid dangling tasks.
- Remove obsolete workflow attachments via the provided migration (`20251031121500_remove_qbo_workflow_automation.cjs`). Once migrations run, no further cleanup is required.
