{
  "id": "00000000-0000-0000-0000-00000000e001",
  "version": 2,
  "name": "Inbound Email Processing",
  "description": "Process inbound emails into tickets or comments.",
  "payloadSchemaRef": "payload.EmailWorkflowPayload.v1",
  "trigger": { "type": "event", "eventName": "INBOUND_EMAIL_RECEIVED" },
  "steps": [
    {
      "id": "try-email-processing",
      "type": "control.tryCatch",
      "try": [
        {
          "id": "state-processing-inbound",
          "type": "state.set",
          "config": { "state": "PROCESSING_INBOUND_EMAIL" }
        },
        {
          "id": "assign-trigger-fields",
          "type": "transform.assign",
          "config": {
            "assign": {
              "vars.processedAt": { "$expr": "nowIso()" }
            }
          }
        },
        {
          "id": "parse-email-body",
          "type": "email.parseBody",
          "config": {
            "text": { "$expr": "payload.emailData.body.text" },
            "html": { "$expr": "payload.emailData.body.html" },
            "saveAs": "vars.parsedEmail"
          }
        },
        {
          "id": "state-check-threading",
          "type": "state.set",
          "config": { "state": "CHECKING_EMAIL_THREADING" }
        },
        {
          "id": "check-reply-token",
          "type": "control.if",
          "condition": { "$expr": "coalesce(vars.parsedEmail.metadata.parser.tokens.conversationToken, '') != ''" },
          "then": [
            {
              "id": "lookup-reply-token",
              "type": "action.call",
              "config": {
                "actionId": "find_ticket_by_reply_token",
                "version": 1,
                "inputMapping": {
                  "token": { "$expr": "vars.parsedEmail.metadata.parser.tokens.conversationToken" }
                },
                "saveAs": "vars.replyTokenResult",
                "onError": { "policy": "continue" }
              }
            }
          ]
        },
        {
          "id": "resolve-threading",
          "type": "control.if",
          "condition": { "$expr": "coalesce(vars.replyTokenResult.success, false) and coalesce(vars.replyTokenResult.match.ticketId, null) != null" },
          "then": [
            {
              "id": "assign-existing-ticket-token",
              "type": "transform.assign",
              "config": {
                "assign": {
                  "vars.existingTicket": { "$expr": "vars.replyTokenResult.match" }
                }
              }
            }
          ],
          "else": [
            {
              "id": "lookup-threading-headers",
              "type": "action.call",
              "config": {
                "actionId": "find_ticket_by_email_thread",
                "version": 1,
                "inputMapping": {
                  "threadId": { "$expr": "payload.emailData.threadId" },
                  "inReplyTo": { "$expr": "payload.emailData.inReplyTo" },
                  "references": { "$expr": "payload.emailData.references" },
                  "originalMessageId": { "$expr": "payload.emailData.inReplyTo" }
                },
                "saveAs": "vars.threadResult",
                "onError": { "policy": "continue" }
              }
            },
            {
              "id": "assign-existing-ticket-thread",
              "type": "control.if",
              "condition": { "$expr": "coalesce(vars.threadResult.success, false) and coalesce(vars.threadResult.ticket, null) != null" },
              "then": [
                {
                  "id": "assign-existing-ticket-thread-value",
                  "type": "transform.assign",
                  "config": {
                    "assign": {
                      "vars.existingTicket": { "$expr": "vars.threadResult.ticket" }
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          "id": "branch-existing-ticket",
          "type": "control.if",
          "condition": { "$expr": "vars.existingTicket != null" },
          "then": [
            {
              "id": "comment-existing-ticket",
              "type": "action.call",
              "config": {
                "actionId": "create_comment_from_email",
                "version": 1,
                "inputMapping": {
                  "ticket_id": { "$expr": "vars.existingTicket.ticketId" },
                  "content": { "$expr": "vars.parsedEmail.sanitizedHtml ? vars.parsedEmail.sanitizedHtml : vars.parsedEmail.sanitizedText" },
                  "format": { "$expr": "vars.parsedEmail.sanitizedHtml ? 'html' : 'text'" },
                  "source": "email",
                  "author_type": "contact",
                  "metadata": { "$expr": "vars.parsedEmail.metadata" }
                },
                "idempotencyKey": { "$expr": "payload.emailData.id & ':' & vars.existingTicket.ticketId" },
                "saveAs": "vars.commentResult"
              }
            },
            {
              "id": "attachments-existing-ticket",
              "type": "control.forEach",
              "items": { "$expr": "coalesce(payload.emailData.attachments, [])" },
              "itemVar": "attachment",
              "onItemError": "continue",
              "body": [
                {
                  "id": "process-existing-attachment",
                  "type": "action.call",
                  "config": {
                    "actionId": "process_email_attachment",
                    "version": 1,
                    "inputMapping": {
                      "emailId": { "$expr": "payload.emailData.id" },
                      "attachmentId": { "$expr": "vars.attachment.id" },
                      "ticketId": { "$expr": "vars.existingTicket.ticketId" },
                      "tenant": { "$expr": "payload.tenantId" },
                      "providerId": { "$expr": "payload.providerId" },
                      "attachmentData": { "$expr": "vars.attachment" }
                    },
                    "idempotencyKey": { "$expr": "payload.emailData.id & ':' & vars.attachment.id" },
                    "onError": { "policy": "continue" }
                  }
                }
              ]
            },
            { "id": "return-after-reply", "type": "control.return" }
          ],
          "else": [
            {
              "id": "state-matching-client",
              "type": "state.set",
              "config": { "state": "MATCHING_EMAIL_CLIENT" }
            },
            {
              "id": "match-contact",
              "type": "action.call",
              "config": {
                "actionId": "find_contact_by_email",
                "version": 1,
                "inputMapping": {
                  "email": { "$expr": "payload.emailData.from.email" }
                },
                "saveAs": "vars.matchedContact",
                "onError": { "policy": "continue" }
              }
            },
            {
              "id": "assign-matched-client",
              "type": "control.if",
              "condition": { "$expr": "coalesce(vars.matchedContact.success, false) and coalesce(vars.matchedContact.contact, null) != null" },
              "then": [
                {
                  "id": "assign-matched-client-value",
                  "type": "transform.assign",
                  "config": {
                    "assign": {
                      "vars.matchedClient": { "$expr": "vars.matchedContact.contact" }
                    }
                  }
                }
              ]
            },
            {
              "id": "state-resolve-defaults",
              "type": "state.set",
              "config": { "state": "RESOLVING_TICKET_DEFAULTS" }
            },
            {
              "id": "resolve-ticket-defaults",
              "type": "action.call",
              "config": {
                "actionId": "resolve_inbound_ticket_defaults",
                "version": 1,
                "inputMapping": {
                  "tenant": { "$expr": "payload.tenantId" },
                  "providerId": { "$expr": "payload.providerId" }
                },
                "saveAs": "vars.ticketDefaults"
              }
            },
            {
              "id": "check-ticket-defaults",
              "type": "control.if",
              "condition": { "$expr": "vars.ticketDefaults != null" },
              "then": [],
              "else": [
                {
                  "id": "state-error-no-defaults",
                  "type": "state.set",
                  "config": { "state": "ERROR_NO_TICKET_DEFAULTS" }
                },
                { "id": "return-no-defaults", "type": "control.return" }
              ]
            },
            {
              "id": "state-create-ticket",
              "type": "state.set",
              "config": { "state": "CREATING_TICKET" }
            },
            {
              "id": "compute-targets",
              "type": "transform.assign",
              "config": {
                "assign": {
                  "vars.targetClientId": { "$expr": "coalesce(vars.matchedContact.contact.client_id, vars.ticketDefaults.client_id)" },
                  "vars.targetContactId": { "$expr": "coalesce(vars.matchedContact.contact.contact_id, null)" },
                  "vars.targetLocationId": { "$expr": "(vars.matchedContact.contact.client_id and vars.ticketDefaults.client_id and vars.matchedContact.contact.client_id != vars.ticketDefaults.client_id) ? null : vars.ticketDefaults.location_id" }
                }
              }
            },
            {
              "id": "create-ticket",
              "type": "action.call",
              "config": {
                "actionId": "create_ticket_from_email",
                "version": 1,
                "inputMapping": {
                  "title": { "$expr": "payload.emailData.subject" },
                  "description": { "$expr": "vars.parsedEmail.sanitizedText" },
                  "client_id": { "$expr": "vars.targetClientId" },
                  "contact_id": { "$expr": "vars.targetContactId" },
                  "source": "email",
                  "board_id": { "$expr": "vars.ticketDefaults.board_id" },
                  "status_id": { "$expr": "vars.ticketDefaults.status_id" },
                  "priority_id": { "$expr": "vars.ticketDefaults.priority_id" },
                  "category_id": { "$expr": "vars.ticketDefaults.category_id" },
                  "subcategory_id": { "$expr": "vars.ticketDefaults.subcategory_id" },
                  "location_id": { "$expr": "vars.targetLocationId" },
                  "entered_by": { "$expr": "vars.ticketDefaults.entered_by" },
                  "email_metadata": {
                    "messageId": { "$expr": "payload.emailData.id" },
                    "mailhogId": { "$expr": "payload.emailData.mailhogId" },
                    "threadId": { "$expr": "payload.emailData.threadId" },
                    "from": { "$expr": "payload.emailData.from" },
                    "inReplyTo": { "$expr": "payload.emailData.inReplyTo" },
                    "references": { "$expr": "payload.emailData.references" },
                    "providerId": { "$expr": "payload.providerId" }
                  }
                },
                "idempotencyKey": { "$expr": "payload.providerId & ':' & payload.emailData.id" },
                "saveAs": "vars.createdTicket"
              }
            },
            {
              "id": "assign-target-ticket-id",
              "type": "transform.assign",
              "config": {
                "assign": {
                  "vars.targetTicketId": { "$expr": "vars.createdTicket.ticket_id" }
                }
              }
            },
            {
              "id": "state-processing-attachments",
              "type": "state.set",
              "config": { "state": "PROCESSING_ATTACHMENTS" }
            },
            {
              "id": "attachments-new-ticket",
              "type": "control.forEach",
              "items": { "$expr": "coalesce(payload.emailData.attachments, [])" },
              "itemVar": "attachment",
              "onItemError": "continue",
              "body": [
                {
                  "id": "process-new-attachment",
                  "type": "action.call",
                  "config": {
                    "actionId": "process_email_attachment",
                    "version": 1,
                    "inputMapping": {
                      "emailId": { "$expr": "payload.emailData.id" },
                      "attachmentId": { "$expr": "vars.attachment.id" },
                      "ticketId": { "$expr": "vars.targetTicketId" },
                      "tenant": { "$expr": "payload.tenantId" },
                      "providerId": { "$expr": "payload.providerId" },
                      "attachmentData": { "$expr": "vars.attachment" }
                    },
                    "idempotencyKey": { "$expr": "payload.emailData.id & ':' & vars.attachment.id" },
                    "onError": { "policy": "continue" }
                  }
                }
              ]
            },
            {
              "id": "create-initial-comment",
              "type": "action.call",
              "config": {
                "actionId": "create_comment_from_email",
                "version": 1,
                "inputMapping": {
                  "ticket_id": { "$expr": "vars.targetTicketId" },
                  "content": { "$expr": "vars.parsedEmail.sanitizedHtml ? vars.parsedEmail.sanitizedHtml : vars.parsedEmail.sanitizedText" },
                  "format": { "$expr": "vars.parsedEmail.sanitizedHtml ? 'html' : 'text'" },
                  "source": "email",
                  "author_type": "internal",
                  "metadata": { "$expr": "vars.parsedEmail.metadata" }
                },
                "idempotencyKey": { "$expr": "payload.emailData.id & ':' & vars.targetTicketId" }
              }
            },
            {
              "id": "state-email-processed",
              "type": "state.set",
              "config": { "state": "EMAIL_PROCESSED" }
            },
            {
              "id": "send-ack-email",
              "type": "control.if",
              "condition": { "$expr": "vars.matchedClient != null" },
              "then": [
                {
                  "id": "ack-email-action",
                  "type": "action.call",
                  "config": {
                    "actionId": "send_ticket_acknowledgement_email",
                    "version": 1,
                    "inputMapping": {
                      "ticketId": { "$expr": "vars.targetTicketId" },
                      "contactEmail": { "$expr": "vars.matchedClient.email" }
                    },
                    "onError": { "policy": "continue" }
                  }
                }
              ]
            },
            { "id": "return-after-create", "type": "control.return" }
          ]
        }
      ],
      "catch": [
        {
          "id": "state-error-processing",
          "type": "state.set",
          "config": { "state": "ERROR_PROCESSING_EMAIL" }
        },
        {
          "id": "create-human-task-failure",
          "type": "action.call",
          "config": {
            "actionId": "create_human_task_for_email_processing_failure",
            "version": 1,
            "inputMapping": {
              "title": "Email Processing Failure",
              "description": { "$expr": "payload.emailData.subject" },
              "contextData": {
                "emailSubject": { "$expr": "payload.emailData.subject" },
                "senderEmail": { "$expr": "payload.emailData.from.email" },
                "emailId": { "$expr": "payload.emailData.id" },
                "providerId": { "$expr": "payload.providerId" },
                "errorMessage": { "$expr": "error.message" }
              }
            }
          }
        },
        {
          "id": "state-awaiting-manual",
          "type": "state.set",
          "config": { "state": "AWAITING_MANUAL_RESOLUTION" }
        },
        { "id": "return-after-error", "type": "control.return" }
      ]
    }
  ]
}
