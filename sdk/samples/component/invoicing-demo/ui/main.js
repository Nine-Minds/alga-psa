var E="1",m=class{constructor(e){if(this.listeners=new Set,this.sessionToken=null,this.themeTokens={},e?.expectedParentOrigin)this.expectedParentOrigin=e.expectedParentOrigin;else if(typeof window<"u"){let o=new URLSearchParams(window.location.search);this.expectedParentOrigin=o.get("parentOrigin")||window.location.origin}else this.expectedParentOrigin="";let i=typeof process<"u"&&process.env&&!1,a=typeof window<"u"&&window.__ALGA_DEV__===!0;this.devWildcard=e?.devAllowWildcard??!!(i||a),typeof window<"u"&&window.addEventListener("message",o=>{if(!this.devWildcard&&this.expectedParentOrigin&&o.origin!==this.expectedParentOrigin)return;let t=o.data;if(!t||typeof t!="object")return;if(t.alga!==!0||t.version!==E||typeof t.type!="string"){console.warn("[SDK] Ignoring message with invalid envelope",{origin:o.origin,data:t});return}console.log("[SDK] Received host message",{type:t.type,origin:o.origin,requestId:t.request_id}),t.type==="apiproxy_response"&&console.log("[SDK] Received apiproxy_response",{requestId:t.request_id,hasBody:!!t.payload?.body,error:t.payload?.error,origin:o.origin});let d=t;if(d.type==="bootstrap"){let r=d.payload;if(r?.theme_tokens&&typeof document<"u"){this.themeTokens=r.theme_tokens;let s=document.documentElement;Object.entries(this.themeTokens).forEach(([c,l])=>{try{s.style.setProperty(c,String(l))}catch{}})}r?.session?.token&&(this.sessionToken=r.session.token)}this.listeners.forEach(r=>r(d))})}ready(e){this.emitToHost("ready",{},e)}on(e){return this.listeners.add(e),()=>this.listeners.delete(e)}emitToHost(e,i,a){if(typeof window>"u")return;let o={alga:!0,version:E,type:e,request_id:a,payload:i},t=this.devWildcard?"*":this.expectedParentOrigin||"*";window.parent?.postMessage(o,t)}getSessionToken(){return this.sessionToken}getThemeTokens(){return this.themeTokens}setExpectedParentOrigin(e){this.expectedParentOrigin=e}async callProxy(e,i){return new Promise((a,o)=>{let t=typeof crypto<"u"?crypto.randomUUID():String(Math.random());console.log(`[SDK] Starting callProxy for route: ${e}, requestId: ${t}`);let d=this.on(s=>{if(s.type==="apiproxy_response"&&s.request_id===t)if(console.log(`[SDK] Received apiproxy_response for requestId: ${t}`),d(),s.payload.error)console.warn(`[SDK] Proxy response error for requestId: ${t}, error: ${s.payload.error}`),o(new Error(s.payload.error));else{let c=s.payload.body||"";try{let l=atob(c),f=l.length,w=new Uint8Array(f);for(let h=0;h<f;h++)w[h]=l.charCodeAt(h);a(w)}catch(l){console.error(`[SDK] Failed to decode proxy response for requestId: ${t}`,l),o(new Error("Failed to decode proxy response"))}}}),r;if(i){let s="";for(let c=0;c<i.length;c++)s+=String.fromCharCode(i[c]);r=btoa(s)}console.log(`[SDK] Emitting 'apiproxy' message to host. requestId: ${t}`),this.emitToHost("apiproxy",{route:e,body:r},t),setTimeout(()=>{console.warn(`[SDK] Timeout reached for requestId: ${t}`),d(),o(new Error("Proxy request timed out"))},15e3)})}get uiProxy(){return{callRoute:this.callProxy.bind(this),call:this.callProxy.bind(this)}}};var T=new TextEncoder,b=new TextDecoder;function P(n){let e=n;return e.uiProxy?e.uiProxy:n}function v(n,e){let i=n.includes("?")?"&":"?";return`${n}${i}__method=${encodeURIComponent(e)}`}function S(n,e){return e===void 0?{__method:n}:e&&typeof e=="object"&&!Array.isArray(e)?{__method:n,...e}:e}function D(n){let e=(n??"GET").toUpperCase();if(e==="GET"||e==="POST"||e==="PUT"||e==="PATCH"||e==="DELETE")return e;throw new Error(`Unsupported method: ${n}`)}async function g(n,e,i={}){let a=D(i.method),o=P(n),t=o.callRoute??o.call;if(!t)throw new Error("uiProxy host does not implement callRoute");if(a==="GET"&&typeof i.body<"u")throw new Error("GET requests cannot include a body");let d=e,r=i.body;(a==="PUT"||a==="PATCH"||a==="DELETE")&&(d=v(e,a),r=S(a,i.body));let s=typeof r>"u"?void 0:T.encode(JSON.stringify(r)),c=await t.call(o,d,s??void 0),l=b.decode(c);return l.length?JSON.parse(l):null}var x=document.getElementById("output"),p=document.getElementById("btn-create"),I=document.getElementById("btn-status");function y(n){x&&(x.textContent=JSON.stringify(n,null,2))}function u(n){return document.getElementById(n)?.value??""}async function O(){let n=new m({devAllowWildcard:!0});n.ready(),I?.addEventListener("click",async()=>{try{let e=await g(n,"/api/status");y({ok:!0,data:e})}catch(e){y({ok:!1,error:e instanceof Error?e.message:String(e)})}}),p?.addEventListener("click",async()=>{if(p){p.disabled=!0,p.textContent="Creating...";try{let e=u("clientId").trim(),i=u("serviceId").trim(),a=u("invoiceDate").trim(),o=u("dueDate").trim(),t=u("poNumber").trim(),d=Number(u("quantity")),r=Number(u("rateDollars")),s=u("description"),c=Number.isFinite(r)?Math.round(r*100):r,f=await g(n,"/api/create-manual-invoice",{method:"POST",body:{clientId:e,invoiceDate:a||void 0,dueDate:o||void 0,poNumber:t||null,items:[{serviceId:i,quantity:d,description:s,rate:c}]}});y({ok:!0,data:f})}catch(e){y({ok:!1,error:e instanceof Error?e.message:String(e)})}finally{p.disabled=!1,p.textContent="Create Draft Invoice"}}})}O().catch(n=>{y({ok:!1,error:n instanceof Error?n.message:String(n)})});
