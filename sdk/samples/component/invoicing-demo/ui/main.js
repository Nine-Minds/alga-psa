var w="1",m=class{constructor(e){if(this.listeners=new Set,this.sessionToken=null,this.themeTokens={},e?.expectedParentOrigin)this.expectedParentOrigin=e.expectedParentOrigin;else if(typeof window<"u"){let n=new URLSearchParams(window.location.search);this.expectedParentOrigin=n.get("parentOrigin")||window.location.origin}else this.expectedParentOrigin="";let s=typeof process<"u"&&process.env&&!1,a=typeof window<"u"&&window.__ALGA_DEV__===!0;this.devWildcard=e?.devAllowWildcard??!!(s||a),typeof window<"u"&&window.addEventListener("message",n=>{if(!this.devWildcard&&this.expectedParentOrigin&&n.origin!==this.expectedParentOrigin)return;let t=n.data;if(!t||typeof t!="object")return;if(t.alga!==!0||t.version!==w||typeof t.type!="string"){console.warn("[SDK] Ignoring message with invalid envelope",{origin:n.origin,data:t});return}console.log("[SDK] Received host message",{type:t.type,origin:n.origin,requestId:t.request_id}),t.type==="apiproxy_response"&&console.log("[SDK] Received apiproxy_response",{requestId:t.request_id,hasBody:!!t.payload?.body,error:t.payload?.error,origin:n.origin});let c=t;if(c.type==="bootstrap"){let r=c.payload;if(r?.theme_tokens&&typeof document<"u"){this.themeTokens=r.theme_tokens;let i=document.documentElement;Object.entries(this.themeTokens).forEach(([d,u])=>{try{i.style.setProperty(d,String(u))}catch{}})}r?.session?.token&&(this.sessionToken=r.session.token)}this.listeners.forEach(r=>r(c))})}ready(e){this.emitToHost("ready",{},e)}on(e){return this.listeners.add(e),()=>this.listeners.delete(e)}emitToHost(e,s,a){if(typeof window>"u")return;let n={alga:!0,version:w,type:e,request_id:a,payload:s},t=this.devWildcard?"*":this.expectedParentOrigin||"*";window.parent?.postMessage(n,t)}getSessionToken(){return this.sessionToken}getThemeTokens(){return this.themeTokens}setExpectedParentOrigin(e){this.expectedParentOrigin=e}async callProxy(e,s){return new Promise((a,n)=>{let t=typeof crypto<"u"?crypto.randomUUID():String(Math.random());console.log(`[SDK] Starting callProxy for route: ${e}, requestId: ${t}`);let c=this.on(i=>{if(i.type==="apiproxy_response"&&i.request_id===t)if(console.log(`[SDK] Received apiproxy_response for requestId: ${t}`),c(),i.payload.error)console.warn(`[SDK] Proxy response error for requestId: ${t}, error: ${i.payload.error}`),n(new Error(i.payload.error));else{let d=i.payload.body||"";try{let u=atob(d),g=u.length,h=new Uint8Array(g);for(let f=0;f<g;f++)h[f]=u.charCodeAt(f);a(h)}catch(u){console.error(`[SDK] Failed to decode proxy response for requestId: ${t}`,u),n(new Error("Failed to decode proxy response"))}}}),r;if(s){let i="";for(let d=0;d<s.length;d++)i+=String.fromCharCode(s[d]);r=btoa(i)}console.log(`[SDK] Emitting 'apiproxy' message to host. requestId: ${t}`),this.emitToHost("apiproxy",{route:e,body:r},t),setTimeout(()=>{console.warn(`[SDK] Timeout reached for requestId: ${t}`),c(),n(new Error("Proxy request timed out"))},15e3)})}get uiProxy(){return{callRoute:this.callProxy.bind(this),call:this.callProxy.bind(this)}}};var E=new TextEncoder,S=new TextDecoder,x=document.getElementById("output"),p=document.getElementById("btn-create"),v=document.getElementById("btn-status");function y(o){x&&(x.textContent=JSON.stringify(o,null,2))}function l(o){return document.getElementById(o)?.value??""}async function b(o,e,s){let a=s===void 0?void 0:E.encode(JSON.stringify(s)),n=await o.uiProxy.callRoute(e,a),t=S.decode(n);return t?JSON.parse(t):null}async function T(){let o=new m({devAllowWildcard:!0});o.ready(),v?.addEventListener("click",async()=>{try{let e=await b(o,"/api/status");y({ok:!0,data:e})}catch(e){y({ok:!1,error:e instanceof Error?e.message:String(e)})}}),p?.addEventListener("click",async()=>{if(p){p.disabled=!0,p.textContent="Creating...";try{let e=l("clientId").trim(),s=l("serviceId").trim(),a=l("invoiceDate").trim(),n=l("dueDate").trim(),t=l("poNumber").trim(),c=Number(l("quantity")),r=Number(l("rateDollars")),i=l("description"),d=Number.isFinite(r)?Math.round(r*100):r,g=await b(o,"/api/create-manual-invoice",{clientId:e,invoiceDate:a||void 0,dueDate:n||void 0,poNumber:t||null,items:[{serviceId:s,quantity:c,description:i,rate:d}]});y({ok:!0,data:g})}catch(e){y({ok:!1,error:e instanceof Error?e.message:String(e)})}finally{p.disabled=!1,p.textContent="Create Draft Invoice"}}})}T().catch(o=>{y({ok:!1,error:o instanceof Error?o.message:String(o)})});
