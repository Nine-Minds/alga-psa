{
  "format": "alga-psa.workflow-bundle",
  "formatVersion": 1,
  "exportedAt": "2026-01-26T00:00:00.000Z",
  "workflows": [
    {
      "key": "fixture.ticket-created-assign-trycatch",
      "metadata": {
        "name": "Fixture: Ticket Created → Assign (Try/Catch)",
        "description": "Try assigning a ticket to an invalid user id; on catch, notify and add an internal comment with the captured error.",
        "payloadSchemaRef": "payload.TicketCreated.v1",
        "payloadSchemaMode": "pinned",
        "pinnedPayloadSchemaRef": "payload.TicketCreated.v1",
        "trigger": { "type": "event", "eventName": "TICKET_CREATED" },
        "isSystem": false,
        "isVisible": true,
        "isPaused": false,
        "concurrencyLimit": null,
        "autoPauseOnFailure": false,
        "failureRateThreshold": null,
        "failureRateMinRuns": null,
        "retentionPolicyOverride": null
      },
      "dependencies": {
        "actions": [
          { "actionId": "tickets.find", "version": 1 },
          { "actionId": "tickets.assign", "version": 1 },
          { "actionId": "tickets.add_comment", "version": 1 },
          { "actionId": "notifications.send_in_app", "version": 1 }
        ],
        "nodeTypes": ["action.call", "control.return", "control.tryCatch", "state.set", "transform.assign"],
        "schemaRefs": ["payload.TicketCreated.v1"]
      },
      "draft": {
        "draftVersion": 1,
        "definition": {
          "id": "00000000-0000-0000-0000-00000000f130",
          "version": 1,
          "name": "Fixture: Ticket Created → Assign (Try/Catch)",
          "description": "Try assigning a ticket to an invalid user id; on catch, notify and add an internal comment with the captured error.",
          "payloadSchemaRef": "payload.TicketCreated.v1",
          "trigger": { "type": "event", "eventName": "TICKET_CREATED" },
          "steps": [
            { "id": "state-trycatch", "type": "state.set", "config": { "state": "TRY_CATCH" } },
            {
              "id": "load-ticket",
              "type": "action.call",
              "config": {
                "actionId": "tickets.find",
                "version": 1,
                "inputMapping": {
                  "ticket_id": { "$expr": "payload.ticketId" },
                  "include": { "attributes": true }
                },
                "saveAs": "vars.lookup"
              }
            },
            {
              "id": "assign-fixture-vars",
              "type": "transform.assign",
              "config": {
                "assign": {
                  "vars.badAssigneeUserId": { "$expr": "vars.lookup.ticket.attributes.fixture_bad_assignee_user_id" },
                  "vars.notifyUserId": { "$expr": "vars.lookup.ticket.attributes.fixture_notify_user_id" },
                  "vars.marker": { "$expr": "'[fixture ticket-created-assign-trycatch]'" }
                }
              }
            },
            {
              "id": "try-assign",
              "type": "control.tryCatch",
              "captureErrorAs": "caughtError",
              "try": [
                {
                  "id": "assign-ticket",
                  "type": "action.call",
                  "config": {
                    "actionId": "tickets.assign",
                    "version": 1,
                    "inputMapping": {
                      "ticket_id": { "$expr": "payload.ticketId" },
                      "assignee": { "type": "user", "id": { "$expr": "vars.badAssigneeUserId" } },
                      "reason": "fixture try/catch invalid user"
                    }
                  }
                },
                { "id": "return-after-assign", "type": "control.return" }
              ],
              "catch": [
                {
                  "id": "assign-error-text",
                  "type": "transform.assign",
                  "config": {
                    "assign": {
                      "vars.errorMessage": { "$expr": "coalesce(vars.caughtError.message, 'unknown error')" },
                      "vars.title": { "$expr": "vars.marker & ' Assign failed'" },
                      "vars.body": { "$expr": "'ticketId=' & payload.ticketId & ' error=' & vars.errorMessage" }
                    }
                  }
                },
                {
                  "id": "notify-admin",
                  "type": "action.call",
                  "config": {
                    "actionId": "notifications.send_in_app",
                    "version": 1,
                    "inputMapping": {
                      "recipients": { "$expr": "{ \"user_ids\": [vars.notifyUserId] }" },
                      "title": { "$expr": "vars.title" },
                      "body": { "$expr": "vars.body" },
                      "severity": "warning",
                      "dedupe_key": { "$expr": "'fixture.ticket-created-assign-trycatch:' & payload.ticketId" }
                    }
                  }
                },
                {
                  "id": "comment-error",
                  "type": "action.call",
                  "config": {
                    "actionId": "tickets.add_comment",
                    "version": 1,
                    "inputMapping": {
                      "ticket_id": { "$expr": "payload.ticketId" },
                      "body": { "$expr": "vars.body" },
                      "visibility": "internal",
                      "idempotency_key": { "$expr": "'fixture.ticket-created-assign-trycatch:' & payload.ticketId" }
                    }
                  }
                },
                { "id": "return-after-catch", "type": "control.return" }
              ]
            }
          ]
        }
      },
      "publishedVersions": [
        {
          "version": 1,
          "definition": {
            "id": "00000000-0000-0000-0000-00000000f130",
            "version": 1,
            "name": "Fixture: Ticket Created → Assign (Try/Catch)",
            "description": "Try assigning a ticket to an invalid user id; on catch, notify and add an internal comment with the captured error.",
            "payloadSchemaRef": "payload.TicketCreated.v1",
            "trigger": { "type": "event", "eventName": "TICKET_CREATED" },
            "steps": [
              { "id": "state-trycatch", "type": "state.set", "config": { "state": "TRY_CATCH" } },
              {
                "id": "load-ticket",
                "type": "action.call",
                "config": {
                  "actionId": "tickets.find",
                  "version": 1,
                  "inputMapping": {
                    "ticket_id": { "$expr": "payload.ticketId" },
                    "include": { "attributes": true }
                  },
                  "saveAs": "vars.lookup"
                }
              },
              {
                "id": "assign-fixture-vars",
                "type": "transform.assign",
                "config": {
                  "assign": {
                    "vars.badAssigneeUserId": { "$expr": "vars.lookup.ticket.attributes.fixture_bad_assignee_user_id" },
                    "vars.notifyUserId": { "$expr": "vars.lookup.ticket.attributes.fixture_notify_user_id" },
                    "vars.marker": { "$expr": "'[fixture ticket-created-assign-trycatch]'" }
                  }
                }
              },
              {
                "id": "try-assign",
                "type": "control.tryCatch",
                "captureErrorAs": "caughtError",
                "try": [
                  {
                    "id": "assign-ticket",
                    "type": "action.call",
                    "config": {
                      "actionId": "tickets.assign",
                      "version": 1,
                      "inputMapping": {
                        "ticket_id": { "$expr": "payload.ticketId" },
                        "assignee": { "type": "user", "id": { "$expr": "vars.badAssigneeUserId" } },
                        "reason": "fixture try/catch invalid user"
                      }
                    }
                  },
                  { "id": "return-after-assign", "type": "control.return" }
                ],
                "catch": [
                  {
                    "id": "assign-error-text",
                    "type": "transform.assign",
                    "config": {
                      "assign": {
                        "vars.errorMessage": { "$expr": "coalesce(vars.caughtError.message, 'unknown error')" },
                        "vars.title": { "$expr": "vars.marker & ' Assign failed'" },
                        "vars.body": { "$expr": "'ticketId=' & payload.ticketId & ' error=' & vars.errorMessage" }
                      }
                    }
                  },
                  {
                    "id": "notify-admin",
                    "type": "action.call",
                    "config": {
                      "actionId": "notifications.send_in_app",
                      "version": 1,
                      "inputMapping": {
                        "recipients": { "$expr": "{ \"user_ids\": [vars.notifyUserId] }" },
                        "title": { "$expr": "vars.title" },
                        "body": { "$expr": "vars.body" },
                        "severity": "warning",
                        "dedupe_key": { "$expr": "'fixture.ticket-created-assign-trycatch:' & payload.ticketId" }
                      }
                    }
                  },
                  {
                    "id": "comment-error",
                    "type": "action.call",
                    "config": {
                      "actionId": "tickets.add_comment",
                      "version": 1,
                      "inputMapping": {
                        "ticket_id": { "$expr": "payload.ticketId" },
                        "body": { "$expr": "vars.body" },
                        "visibility": "internal",
                        "idempotency_key": { "$expr": "'fixture.ticket-created-assign-trycatch:' & payload.ticketId" }
                      }
                    }
                  },
                  { "id": "return-after-catch", "type": "control.return" }
                ]
              }
            ]
          },
          "payloadSchemaJson": null
        }
      ]
    }
  ]
}

