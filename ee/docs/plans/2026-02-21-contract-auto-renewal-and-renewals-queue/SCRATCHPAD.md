# Scratchpad — Contract Auto-Renewal and Renewals Queue

- Plan slug: `contract-auto-renewal-and-renewals-queue`
- Created: `2026-02-21`

## What This Is
Rolling implementation memory for renewal settings + actionable renewals queue + automation ticketing.

## Decisions
- (2026-02-21) Build an **actionable queue** (not read-only report).
- (2026-02-21) Ship **both** dashboard entry and full queue page (`Client Contracts` widget + `Renewals` tab).
- (2026-02-21) Primary operational date is **renewal decision due date**.
- (2026-02-21) Due-date behavior is configurable with **tenant defaults + optional per-contract override**.
- (2026-02-21) Default automation target at due date: **create internal ticket**.
- (2026-02-21) Minimum queue actions for v1: `Mark renewing`, `Mark non-renewing`, `Create renewal draft`, `Snooze`.
- (2026-02-21) Default queue horizon: **90 days**, grouped `0-30`, `31-60`, `61-90`.
- (2026-02-21) Queue includes **fixed-term + evergreen anniversaries**.
- (2026-02-21) `Mark renewing` should **auto-create renewal draft** and open it.
- (2026-02-21) Release approach: **single release** scope.
- (2026-02-21) Automation runtime note: support **pg-boss for on-prem** and **Temporal for hosted/EE**.

## Discoveries / Constraints
- (2026-02-21) Runtime selection already exists in `server/src/lib/jobs/JobRunnerFactory.ts` with config/env-based choice and fallback behavior; default is pg-boss unless configured otherwise.
- (2026-02-21) Existing scheduled jobs in `server/src/lib/jobs/initializeScheduledJobs.ts` explicitly branch for enterprise/temporal behavior in some paths; renewal automation should follow same compatibility pattern.
- (2026-02-21) Contract lifecycle already emits `CONTRACT_CREATED` and `CONTRACT_RENEWAL_UPCOMING` in both `packages/clients/src/actions/clientContractActions.ts` and `packages/billing/src/actions/contractWizardActions.ts`.
- (2026-02-21) `CONTRACT_RENEWAL_UPCOMING` computation today is window-based (`DEFAULT_CONTRACT_RENEWAL_UPCOMING_WINDOW_DAYS = 30`) in `shared/workflow/streams/domainEventBuilders/contractEventBuilders.ts`; queue design requires broader 90-day horizon and due-date semantics.
- (2026-02-21) Existing contract expiration report is currently `end_date`-driven (`packages/billing/src/actions/contractReportActions.ts`, `server/src/lib/reports/definitions/contracts/expiration.ts`).
- (2026-02-21) Billing settings already provide tenant defaults in `default_billing_settings` with client override pattern in `client_billing_settings`; actions in `packages/billing/src/actions/billingSettingsActions.ts` and shared helpers in `shared/billingClients/billingSettings.ts` are reusable design patterns.
- (2026-02-21) Billing UI insertion points are clear:
  - tabs config: `packages/billing/src/components/billing-dashboard/billingTabsConfig.ts`
  - tab content host: `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
  - queue/widget host: `packages/billing/src/components/billing-dashboard/contracts/ClientContractsTab.tsx`
  - wizard basics: `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`
- (2026-02-21) Contract assignment data shape in `server/src/interfaces/contract.interfaces.ts` is assignment-level and suitable for renewal metadata on `IClientContract`.

## Commands / Runbooks
- (2026-02-21) Inspect billing dashboard contract files:
  - `rg -n "ContractWizard|ClientContractsTab|billingTabsConfig|ContractBasicsStep" packages/billing/src/components/billing-dashboard`
- (2026-02-21) Inspect runtime selection + scheduling:
  - `rg -n "JobRunnerFactory|initializeScheduledJobs|EDITION|JOB_RUNNER_TYPE" server/src/lib/jobs`
- (2026-02-21) Inspect contract renewal event publishing:
  - `rg -n "CONTRACT_RENEWAL_UPCOMING|computeContractRenewalUpcoming" packages/billing packages/clients shared/workflow`
- (2026-02-21) Validate plan artifacts:
  - `python3 /Users/roberisaacs/.codex/skills/alga-plan/scripts/validate_plan.py ee/docs/plans/2026-02-21-contract-auto-renewal-and-renewals-queue`

## Links / References
- Key plan path: `ee/docs/plans/2026-02-21-contract-auto-renewal-and-renewals-queue`
- Runtime selection: `server/src/lib/jobs/JobRunnerFactory.ts`
- Scheduled job init: `server/src/lib/jobs/initializeScheduledJobs.ts`
- Job scheduler infra: `server/src/lib/jobs/jobScheduler.ts`
- Renewal event builders: `shared/workflow/streams/domainEventBuilders/contractEventBuilders.ts`
- Contract wizard save path: `packages/billing/src/actions/contractWizardActions.ts`
- Client contract actions: `packages/clients/src/actions/clientContractActions.ts`
- Billing settings actions: `packages/billing/src/actions/billingSettingsActions.ts`
- Billing settings shared helpers: `shared/billingClients/billingSettings.ts`
- Billing dashboard tabs host: `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
- Client contracts tab: `packages/billing/src/components/billing-dashboard/contracts/ClientContractsTab.tsx`
- Wizard basics step: `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`

## Implementation Log
- (2026-02-21) Completed `F001`.
  - Added renewal fields to `ContractWizardData` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`:
    - `renewal_mode?: 'none' | 'manual' | 'auto'`
    - `notice_period_days?: number`
    - `renewal_term_months?: number`
    - `use_tenant_renewal_defaults?: boolean`
  - Rationale: establish typed wizard-state shape early so subsequent UI rendering, defaults/hydration, validation, and submission features can build on stable field names.
- (2026-02-21) Completed `T001`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`.
  - Test covers type-level contract for the four renewal fields and validates the allowed `renewal_mode` domain values.
  - Runbook:
    - `npx vitest run packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`
- (2026-02-21) Completed `F002`.
  - Added `createDefaultContractWizardData()` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`.
  - Renewal defaults for new contracts now initialize as:
    - `renewal_mode: 'manual'`
    - `notice_period_days: 30`
    - `renewal_term_months: undefined`
    - `use_tenant_renewal_defaults: true`
  - Updated wizard initialization/reset paths to use the shared factory, keeping default behavior deterministic across first render, open/reset, and edit-merge flows.
- (2026-02-21) Completed `T002`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` with default-state assertions using `createDefaultContractWizardData()`.
  - Validates default renewal state for new contracts: mode `manual`, notice `30`, no term months, tenant-default toggle enabled.
- (2026-02-21) Completed `F003`.
  - Extended `DraftContractWizardData` in `packages/billing/src/actions/contractWizardActions.ts` with renewal fields.
  - Updated `getDraftContractForResume` to hydrate renewal settings from `client_contracts`:
    - normalized `renewal_mode` (`none|manual|auto`)
    - sanitized integer `notice_period_days` (non-negative)
    - sanitized positive integer `renewal_term_months`
    - hydrated `use_tenant_renewal_defaults` when boolean
  - Rationale: resumed drafts now carry renewal metadata into `editingContract` so wizard state merge can restore renewal settings.
- (2026-02-21) Completed `T003`.
  - Added `packages/billing/src/actions/contractWizardActions.renewalDraftResumeWiring.test.ts`.
  - Test validates:
    - renewal fields are present on `DraftContractWizardData`,
    - `getDraftContractForResume` returns hydrated renewal values,
    - numeric renewal values are sanitized before payload return.
- (2026-02-21) Completed `F004`.
  - Added `buildInitialContractWizardData(editingContract)` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`.
  - Edit-mode initialization now explicitly normalizes renewal fields during hydration:
    - validates `renewal_mode` domain,
    - normalizes non-negative `notice_period_days`,
    - normalizes positive `renewal_term_months`,
    - preserves explicit boolean `use_tenant_renewal_defaults`.
  - Wired both initial state and open-effect initialization to use this shared edit-hydration path.
- (2026-02-21) Completed `T004`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`.
  - Added assertions proving edit hydration path uses `buildInitialContractWizardData(editingContract)` and renewal normalization helpers for mode/notice/term.
- (2026-02-21) Completed `F005`.
  - Added a fixed-term renewal UI container to `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - New `Renewal Settings` card renders only when `data.end_date` is present (`data-automation-id=\"renewal-settings-fixed-term-card\"`).
- (2026-02-21) Completed `T005`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts`.
  - Test asserts fixed-term card conditional wiring on `data.end_date` and verifies the automation id/heading token.
- (2026-02-21) Completed `F006`.
  - Added evergreen variant UI in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - New `Evergreen Review Settings` card renders when `data.end_date` is absent (`data-automation-id=\"renewal-settings-evergreen-card\"`).
- (2026-02-21) Completed `T006`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with evergreen-card assertions.
  - Verifies absent-end-date branch and `renewal-settings-evergreen-card` wiring.
- (2026-02-21) Completed `F007`.
  - Added renewal mode selector UI to both fixed-term and evergreen renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Options now explicitly include `none`, `manual`, and `auto`, bound to `data.renewal_mode`.
- (2026-02-21) Completed `T007`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts`.
  - Added assertions for `renewalModeOptions` values (`none|manual|auto`) and `updateData` binding back to `renewal_mode`.
- (2026-02-21) Completed `F008`.
  - Added `Notice Period (Days)` input to both renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Input is conditionally rendered only when renewal mode is enabled (`manual` or `auto`), with non-negative integer coercion on change.
- (2026-02-21) Completed `T008`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with notice-period assertions.
  - Confirms `isRenewalEnabled` gate and both notice input IDs (`fixed` and `evergreen`) are present in the renewal-enabled branch.
- (2026-02-21) Completed `F009`.
  - Added auto-renew specific `Renewal Term (Months)` inputs to fixed-term and evergreen renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Input is gated by `isAutoRenew` and writes sanitized positive integer values to `renewal_term_months`.
- (2026-02-21) Completed `F010`.
  - Confirmed auto-renew term controls are hidden unless `effectiveRenewalMode === 'auto'` via `isAutoRenew` conditional rendering in `ContractBasicsStep.tsx`.
- (2026-02-21) Completed `T009`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with auto-term wiring assertions.
  - Verifies both term input IDs and positive-integer assignment path for `renewal_term_months`.
- (2026-02-21) Completed `T010`.
  - Added explicit `isAutoRenew` gating assertions in `ContractBasicsStep.renewalCards.test.ts`.
  - Verifies auto-specific term controls are conditionally rendered only in `auto` mode.
- (2026-02-21) Completed `F011`.
  - Added step-0 wizard validation in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`:
    - if `end_date` is set and `renewal_mode` is missing, progression is blocked with inline error.
- (2026-02-21) Completed `F012`.
  - Added notice-period validation bounds in `ContractWizard.tsx` (`MIN_NOTICE_PERIOD_DAYS=0`, `MAX_NOTICE_PERIOD_DAYS=3650`).
  - Step-0 validation now requires notice period to be an integer and within bounds whenever renewal mode is enabled.
- (2026-02-21) Completed `F013`.
  - Added step-0 validation rule in `ContractWizard.tsx` requiring `renewal_term_months` to be a positive integer when provided.
- (2026-02-21) Completed `F014`.
  - Renewal validation errors from step-0 rules (`F011`-`F013`) now surface through the wizard’s existing inline step error panel before progression.
- (2026-02-21) Completed `T011`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` with assertions for required renewal mode when `end_date` is set.
- (2026-02-21) Completed `T012`.
  - Marked covered by the same `ContractWizard.renewalFields.test.ts` additions that assert notice-period integer/bounds validation wiring.
- (2026-02-21) Completed `T013`.
  - Marked covered by existing `ContractWizard.renewalFields.test.ts` assertions for positive renewal-term validation when value is provided.
- (2026-02-21) Completed `T014`.
  - Marked covered by existing `ContractWizard.renewalFields.test.ts` assertion that inline step error rendering (`errors[currentStep]`) is present for renewal validation failures.
- (2026-02-21) Completed `F015`.
  - Extended `ContractBasicsStep` summary alert to include renewal preview fields:
    - renewal mode label,
    - notice period (for renewal-enabled modes),
    - renewal term months (auto-renew mode).
- (2026-02-21) Completed `F016`.
  - Extended `ReviewContractStep` “Contract Basics” card to preview renewal fields before submit:
    - renewal mode,
    - notice period,
    - renewal term (auto mode).
- (2026-02-21) Completed `F017`.
  - Added renewal fields to `ClientContractWizardSubmission` (`packages/billing/src/actions/contractWizardActions.ts`).
  - Updated `buildSubmissionData()` in `ContractWizard.tsx` to include renewal mode, notice period, renewal term, and tenant-default toggle in outgoing wizard payload.
- (2026-02-21) Completed `F018`.
  - Updated `createClientContractFromWizard` insert path for `client_contracts` to persist renewal fields.
  - Added schema-compat guards (`hasColumn`) so renewal columns are written when available without breaking pre-migration environments.
- (2026-02-21) Completed `T015`.
  - Extended `ContractBasicsStep.renewalCards.test.ts` to assert renewal mode/notice/term rows are present in the Contract Basics summary preview.
- (2026-02-21) Completed `T016`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ReviewContractStep.renewalPreview.test.ts`.
  - Test covers renewal preview rows and mode-gated rendering conditions in the review step.

## Open Questions
- Should renewal ticket defaults be a brand-new billing settings card, or an extension of existing default ticket settings patterns?
- Should evergreen annual review use contract start-date anniversary or configurable anchor date in v1?
- Should renewal status transitions hard-lock contract activation behavior, or remain advisory with warnings in v1?
