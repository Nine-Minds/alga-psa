# Scratchpad — Contract Auto-Renewal and Renewals Queue

- Plan slug: `contract-auto-renewal-and-renewals-queue`
- Created: `2026-02-21`

## What This Is
Rolling implementation memory for renewal settings + actionable renewals queue + automation ticketing.

## Decisions
- (2026-02-21) Build an **actionable queue** (not read-only report).
- (2026-02-21) Ship **both** dashboard entry and full queue page (`Client Contracts` widget + `Renewals` tab).
- (2026-02-21) Primary operational date is **renewal decision due date**.
- (2026-02-21) Due-date behavior is configurable with **tenant defaults + optional per-contract override**.
- (2026-02-21) Default automation target at due date: **create internal ticket**.
- (2026-02-21) Minimum queue actions for v1: `Mark renewing`, `Mark non-renewing`, `Create renewal draft`, `Snooze`.
- (2026-02-21) Default queue horizon: **90 days**, grouped `0-30`, `31-60`, `61-90`.
- (2026-02-21) Queue includes **fixed-term + evergreen anniversaries**.
- (2026-02-21) `Mark renewing` should **auto-create renewal draft** and open it.
- (2026-02-21) Release approach: **single release** scope.
- (2026-02-21) Automation runtime note: support **pg-boss for on-prem** and **Temporal for hosted/EE**.

## Discoveries / Constraints
- (2026-02-21) Runtime selection already exists in `server/src/lib/jobs/JobRunnerFactory.ts` with config/env-based choice and fallback behavior; default is pg-boss unless configured otherwise.
- (2026-02-21) Existing scheduled jobs in `server/src/lib/jobs/initializeScheduledJobs.ts` explicitly branch for enterprise/temporal behavior in some paths; renewal automation should follow same compatibility pattern.
- (2026-02-21) Contract lifecycle already emits `CONTRACT_CREATED` and `CONTRACT_RENEWAL_UPCOMING` in both `packages/clients/src/actions/clientContractActions.ts` and `packages/billing/src/actions/contractWizardActions.ts`.
- (2026-02-21) `CONTRACT_RENEWAL_UPCOMING` computation today is window-based (`DEFAULT_CONTRACT_RENEWAL_UPCOMING_WINDOW_DAYS = 30`) in `shared/workflow/streams/domainEventBuilders/contractEventBuilders.ts`; queue design requires broader 90-day horizon and due-date semantics.
- (2026-02-21) Existing contract expiration report is currently `end_date`-driven (`packages/billing/src/actions/contractReportActions.ts`, `server/src/lib/reports/definitions/contracts/expiration.ts`).
- (2026-02-21) Billing settings already provide tenant defaults in `default_billing_settings` with client override pattern in `client_billing_settings`; actions in `packages/billing/src/actions/billingSettingsActions.ts` and shared helpers in `shared/billingClients/billingSettings.ts` are reusable design patterns.
- (2026-02-21) Billing UI insertion points are clear:
  - tabs config: `packages/billing/src/components/billing-dashboard/billingTabsConfig.ts`
  - tab content host: `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
  - queue/widget host: `packages/billing/src/components/billing-dashboard/contracts/ClientContractsTab.tsx`
  - wizard basics: `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`
- (2026-02-21) Contract assignment data shape in `server/src/interfaces/contract.interfaces.ts` is assignment-level and suitable for renewal metadata on `IClientContract`.

## Commands / Runbooks
- (2026-02-21) Inspect billing dashboard contract files:
  - `rg -n "ContractWizard|ClientContractsTab|billingTabsConfig|ContractBasicsStep" packages/billing/src/components/billing-dashboard`
- (2026-02-21) Inspect runtime selection + scheduling:
  - `rg -n "JobRunnerFactory|initializeScheduledJobs|EDITION|JOB_RUNNER_TYPE" server/src/lib/jobs`
- (2026-02-21) Inspect contract renewal event publishing:
  - `rg -n "CONTRACT_RENEWAL_UPCOMING|computeContractRenewalUpcoming" packages/billing packages/clients shared/workflow`
- (2026-02-21) Validate plan artifacts:
  - `python3 /Users/roberisaacs/.codex/skills/alga-plan/scripts/validate_plan.py ee/docs/plans/2026-02-21-contract-auto-renewal-and-renewals-queue`

## Links / References
- Key plan path: `ee/docs/plans/2026-02-21-contract-auto-renewal-and-renewals-queue`
- Runtime selection: `server/src/lib/jobs/JobRunnerFactory.ts`
- Scheduled job init: `server/src/lib/jobs/initializeScheduledJobs.ts`
- Job scheduler infra: `server/src/lib/jobs/jobScheduler.ts`
- Renewal event builders: `shared/workflow/streams/domainEventBuilders/contractEventBuilders.ts`
- Contract wizard save path: `packages/billing/src/actions/contractWizardActions.ts`
- Client contract actions: `packages/clients/src/actions/clientContractActions.ts`
- Billing settings actions: `packages/billing/src/actions/billingSettingsActions.ts`
- Billing settings shared helpers: `shared/billingClients/billingSettings.ts`
- Billing dashboard tabs host: `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
- Client contracts tab: `packages/billing/src/components/billing-dashboard/contracts/ClientContractsTab.tsx`
- Wizard basics step: `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`

## Implementation Log
- (2026-02-21) Completed `F001`.
  - Added renewal fields to `ContractWizardData` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`:
    - `renewal_mode?: 'none' | 'manual' | 'auto'`
    - `notice_period_days?: number`
    - `renewal_term_months?: number`
    - `use_tenant_renewal_defaults?: boolean`
  - Rationale: establish typed wizard-state shape early so subsequent UI rendering, defaults/hydration, validation, and submission features can build on stable field names.
- (2026-02-21) Completed `T001`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`.
  - Test covers type-level contract for the four renewal fields and validates the allowed `renewal_mode` domain values.
  - Runbook:
    - `npx vitest run packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`
- (2026-02-21) Completed `F002`.
  - Added `createDefaultContractWizardData()` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`.
  - Renewal defaults for new contracts now initialize as:
    - `renewal_mode: 'manual'`
    - `notice_period_days: 30`
    - `renewal_term_months: undefined`
    - `use_tenant_renewal_defaults: true`
  - Updated wizard initialization/reset paths to use the shared factory, keeping default behavior deterministic across first render, open/reset, and edit-merge flows.
- (2026-02-21) Completed `T002`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` with default-state assertions using `createDefaultContractWizardData()`.
  - Validates default renewal state for new contracts: mode `manual`, notice `30`, no term months, tenant-default toggle enabled.
- (2026-02-21) Completed `F003`.
  - Extended `DraftContractWizardData` in `packages/billing/src/actions/contractWizardActions.ts` with renewal fields.
  - Updated `getDraftContractForResume` to hydrate renewal settings from `client_contracts`:
    - normalized `renewal_mode` (`none|manual|auto`)
    - sanitized integer `notice_period_days` (non-negative)
    - sanitized positive integer `renewal_term_months`
    - hydrated `use_tenant_renewal_defaults` when boolean
  - Rationale: resumed drafts now carry renewal metadata into `editingContract` so wizard state merge can restore renewal settings.
- (2026-02-21) Completed `T003`.
  - Added `packages/billing/src/actions/contractWizardActions.renewalDraftResumeWiring.test.ts`.
  - Test validates:
    - renewal fields are present on `DraftContractWizardData`,
    - `getDraftContractForResume` returns hydrated renewal values,
    - numeric renewal values are sanitized before payload return.
- (2026-02-21) Completed `F004`.
  - Added `buildInitialContractWizardData(editingContract)` in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`.
  - Edit-mode initialization now explicitly normalizes renewal fields during hydration:
    - validates `renewal_mode` domain,
    - normalizes non-negative `notice_period_days`,
    - normalizes positive `renewal_term_months`,
    - preserves explicit boolean `use_tenant_renewal_defaults`.
  - Wired both initial state and open-effect initialization to use this shared edit-hydration path.
- (2026-02-21) Completed `T004`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`.
  - Added assertions proving edit hydration path uses `buildInitialContractWizardData(editingContract)` and renewal normalization helpers for mode/notice/term.
- (2026-02-21) Completed `F005`.
  - Added a fixed-term renewal UI container to `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - New `Renewal Settings` card renders only when `data.end_date` is present (`data-automation-id=\"renewal-settings-fixed-term-card\"`).
- (2026-02-21) Completed `T005`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts`.
  - Test asserts fixed-term card conditional wiring on `data.end_date` and verifies the automation id/heading token.
- (2026-02-21) Completed `F006`.
  - Added evergreen variant UI in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - New `Evergreen Review Settings` card renders when `data.end_date` is absent (`data-automation-id=\"renewal-settings-evergreen-card\"`).
- (2026-02-21) Completed `T006`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with evergreen-card assertions.
  - Verifies absent-end-date branch and `renewal-settings-evergreen-card` wiring.
- (2026-02-21) Completed `F007`.
  - Added renewal mode selector UI to both fixed-term and evergreen renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Options now explicitly include `none`, `manual`, and `auto`, bound to `data.renewal_mode`.
- (2026-02-21) Completed `T007`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts`.
  - Added assertions for `renewalModeOptions` values (`none|manual|auto`) and `updateData` binding back to `renewal_mode`.
- (2026-02-21) Completed `F008`.
  - Added `Notice Period (Days)` input to both renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Input is conditionally rendered only when renewal mode is enabled (`manual` or `auto`), with non-negative integer coercion on change.
- (2026-02-21) Completed `T008`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with notice-period assertions.
  - Confirms `isRenewalEnabled` gate and both notice input IDs (`fixed` and `evergreen`) are present in the renewal-enabled branch.
- (2026-02-21) Completed `F009`.
  - Added auto-renew specific `Renewal Term (Months)` inputs to fixed-term and evergreen renewal cards in `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.tsx`.
  - Input is gated by `isAutoRenew` and writes sanitized positive integer values to `renewal_term_months`.
- (2026-02-21) Completed `F010`.
  - Confirmed auto-renew term controls are hidden unless `effectiveRenewalMode === 'auto'` via `isAutoRenew` conditional rendering in `ContractBasicsStep.tsx`.
- (2026-02-21) Completed `T009`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ContractBasicsStep.renewalCards.test.ts` with auto-term wiring assertions.
  - Verifies both term input IDs and positive-integer assignment path for `renewal_term_months`.
- (2026-02-21) Completed `T010`.
  - Added explicit `isAutoRenew` gating assertions in `ContractBasicsStep.renewalCards.test.ts`.
  - Verifies auto-specific term controls are conditionally rendered only in `auto` mode.
- (2026-02-21) Completed `F011`.
  - Added step-0 wizard validation in `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.tsx`:
    - if `end_date` is set and `renewal_mode` is missing, progression is blocked with inline error.
- (2026-02-21) Completed `F012`.
  - Added notice-period validation bounds in `ContractWizard.tsx` (`MIN_NOTICE_PERIOD_DAYS=0`, `MAX_NOTICE_PERIOD_DAYS=3650`).
  - Step-0 validation now requires notice period to be an integer and within bounds whenever renewal mode is enabled.
- (2026-02-21) Completed `F013`.
  - Added step-0 validation rule in `ContractWizard.tsx` requiring `renewal_term_months` to be a positive integer when provided.
- (2026-02-21) Completed `F014`.
  - Renewal validation errors from step-0 rules (`F011`-`F013`) now surface through the wizard’s existing inline step error panel before progression.
- (2026-02-21) Completed `T011`.
  - Extended `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` with assertions for required renewal mode when `end_date` is set.
- (2026-02-21) Completed `T012`.
  - Marked covered by the same `ContractWizard.renewalFields.test.ts` additions that assert notice-period integer/bounds validation wiring.
- (2026-02-21) Completed `T013`.
  - Marked covered by existing `ContractWizard.renewalFields.test.ts` assertions for positive renewal-term validation when value is provided.
- (2026-02-21) Completed `T014`.
  - Marked covered by existing `ContractWizard.renewalFields.test.ts` assertion that inline step error rendering (`errors[currentStep]`) is present for renewal validation failures.
- (2026-02-21) Completed `F015`.
  - Extended `ContractBasicsStep` summary alert to include renewal preview fields:
    - renewal mode label,
    - notice period (for renewal-enabled modes),
    - renewal term months (auto-renew mode).
- (2026-02-21) Completed `F016`.
  - Extended `ReviewContractStep` “Contract Basics” card to preview renewal fields before submit:
    - renewal mode,
    - notice period,
    - renewal term (auto mode).
- (2026-02-21) Completed `F017`.
  - Added renewal fields to `ClientContractWizardSubmission` (`packages/billing/src/actions/contractWizardActions.ts`).
  - Updated `buildSubmissionData()` in `ContractWizard.tsx` to include renewal mode, notice period, renewal term, and tenant-default toggle in outgoing wizard payload.
- (2026-02-21) Completed `F018`.
  - Updated `createClientContractFromWizard` insert path for `client_contracts` to persist renewal fields.
  - Added schema-compat guards (`hasColumn`) so renewal columns are written when available without breaking pre-migration environments.
- (2026-02-21) Completed `T015`.
  - Extended `ContractBasicsStep.renewalCards.test.ts` to assert renewal mode/notice/term rows are present in the Contract Basics summary preview.
- (2026-02-21) Completed `T016`.
  - Added `packages/billing/src/components/billing-dashboard/contracts/wizard-steps/ReviewContractStep.renewalPreview.test.ts`.
  - Test covers renewal preview rows and mode-gated rendering conditions in the review step.
- (2026-02-21) Completed `T017`.
  - Extended `ContractWizard.renewalFields.test.ts` to assert `buildSubmissionData()` includes all renewal fields in outgoing wizard payload.
- (2026-02-21) Completed `T018`.
  - Extended `contractWizardActions.renewalDraftResumeWiring.test.ts` to assert draft/client save path writes renewal fields into `client_contracts` with schema-guarded `hasColumn` checks.
- (2026-02-21) Completed `F019`.
  - Extended tenant default billing settings model surface in `packages/billing/src/actions/billingSettingsActions.ts` and `server/src/interfaces/billing.interfaces.ts` with renewal-default fields (including default renewal mode) using schema-guarded writes for compatibility.
- (2026-02-21) Completed `F020`.
  - Included `defaultNoticePeriodDays` mapping (`default_notice_period_days`) in tenant default billing settings model and guarded write path.
- (2026-02-21) Completed `F021`.
  - Included `renewalDueDateActionPolicy` mapping (`renewal_due_date_action_policy`) with normalized fallback in tenant billing settings model.
- (2026-02-21) Completed `F022`.
  - Included tenant default renewal ticket board field mapping (`renewal_ticket_board_id`) in billing settings model/read-write path.
- (2026-02-21) Completed `F023`.
  - Included tenant default renewal ticket status field mapping (`renewal_ticket_status_id`) in billing settings model/read-write path.
- (2026-02-21) Completed `F024`.
  - Included tenant default renewal ticket priority field mapping (`renewal_ticket_priority`) in billing settings model/read-write path.
- (2026-02-21) Completed `F025`.
  - Included tenant default renewal ticket assignee field mapping (`renewal_ticket_assignee_id`) in billing settings model/read-write path.
- (2026-02-21) Completed `F026`.
  - `getDefaultBillingSettings` now returns renewal default fields (mode, notice days, due-date policy, ticket routing defaults) with deterministic fallbacks.
- (2026-02-21) Completed `F027`.
  - `updateDefaultBillingSettings` now writes renewal default fields via schema-guarded update/insert payloads.
- (2026-02-21) Completed `T019`.
  - Added `packages/billing/src/actions/billingSettingsActions.renewalDefaultsWiring.test.ts` and marked renewal-mode model coverage.
- (2026-02-21) Completed `T020`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `defaultNoticePeriodDays`.
- (2026-02-21) Completed `T021`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `renewalDueDateActionPolicy`.
- (2026-02-21) Completed `T022`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `renewalTicketBoardId`.
- (2026-02-21) Completed `T023`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `renewalTicketStatusId`.
- (2026-02-21) Completed `T024`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `renewalTicketPriority`.
- (2026-02-21) Completed `T025`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `renewalTicketAssigneeId`.
- (2026-02-21) Completed `T026`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for `getDefaultBillingSettings` renewal default response mapping.
- (2026-02-21) Completed `T027`.
  - Covered by existing `billingSettingsActions.renewalDefaultsWiring.test.ts` assertions for schema-guarded renewal default persistence in update writes.
- (2026-02-21) Completed `T028`.
  - Extended renewal UI/source tests to assert `Use Tenant Renewal Defaults` toggle controls and payload field wiring (`use_tenant_renewal_defaults`).
- (2026-02-21) Completed `T029`.
  - Covered by `ContractWizard.renewalFields.test.ts` assertions that tenant defaults are applied in submission resolution when toggle is enabled.
- (2026-02-21) Completed `T030`.
  - Covered by `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` assertion:
    - `prefers explicit contract override values when tenant defaults are disabled`.
  - Validation run:
    - `cd server && npx vitest run --coverage.enabled=false ../packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`
- (2026-02-21) Completed `T031`.
  - Covered by `packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts` assertion:
    - `uses deterministic fallback precedence for partial override/default state`.
  - Validation run:
    - `cd server && npx vitest run --coverage.enabled=false ../packages/billing/src/components/billing-dashboard/contracts/ContractWizard.renewalFields.test.ts`
- (2026-02-21) Completed `F028`.
  - Added explicit `Use Tenant Renewal Defaults` toggle controls to both fixed-term and evergreen renewal settings cards in `ContractBasicsStep.tsx`, bound to `use_tenant_renewal_defaults`.
- (2026-02-21) Completed `F029`.
  - Updated `buildSubmissionData()` in `ContractWizard.tsx` to resolve renewal mode + notice period from tenant defaults when `use_tenant_renewal_defaults` is enabled.
- (2026-02-21) Completed `F030`.
  - Submission resolution now prefers explicit contract-level renewal values when `use_tenant_renewal_defaults` is disabled.
- (2026-02-21) Completed `F031`.
  - Implemented deterministic renewal fallback order in submission resolution:
    - explicit contract values (when overrides enabled),
    - tenant defaults,
    - hard defaults (`manual`, `30`).
- (2026-02-21) Completed `F032`.
  - Extended contract-assignment read APIs to expose normalized/effective renewal settings in both shared and clients data-access layers:
    - `shared/billingClients/clientContracts.ts`
    - `packages/clients/src/models/clientContract.ts`
  - Added schema-guarded tenant-default joins (`default_billing_settings`) for read paths and computed:
    - `effective_renewal_mode`
    - `effective_notice_period_days`
  - Added type surface fields on `IClientContract` in:
    - `packages/types/src/interfaces/contract.interfaces.ts`
    - `server/src/interfaces/contract.interfaces.ts`
  - Validation run:
    - `npm -w @alga-psa/shared run typecheck`
    - `npm -w @alga-psa/clients run typecheck`
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F033`.
  - Added fixed-term `decision_due_date` computation in assignment normalization paths:
    - `shared/billingClients/clientContracts.ts`
    - `packages/clients/src/models/clientContract.ts`
  - Formula implemented with date-only semantics for fixed-term contracts:
    - `decision_due_date = end_date - effective_notice_period_days`
  - Added `decision_due_date` to contract interfaces:
    - `packages/types/src/interfaces/contract.interfaces.ts`
    - `server/src/interfaces/contract.interfaces.ts`
  - Expanded test coverage in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`.
- (2026-02-21) Completed `F034`.
  - Added evergreen annual-review anchor computation based on contract start-date anniversary rules.
  - New shared helper:
    - `computeNextEvergreenReviewAnchorDate` in `shared/billingClients/clientContracts.ts`
  - Exposed normalized field on active evergreen assignments:
    - `evergreen_review_anchor_date`
  - Mirrored logic in clients model read normalization for parity:
    - `packages/clients/src/models/clientContract.ts`
  - Expanded tests in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`.
- (2026-02-21) Completed `F035`.
  - Added evergreen `decision_due_date` computation from annual anchor minus effective notice period.
  - New shared helper:
    - `computeEvergreenDecisionDueDate` in `shared/billingClients/clientContracts.ts`
  - Applied in both read normalization paths (shared + clients model) so evergreen assignments now expose date-only `decision_due_date`.
  - Expanded deterministic date-math coverage in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`.
- (2026-02-21) Completed `F036`.
  - Confirmed and codified date-only normalization for `decision_due_date` math using `normalizeDateOnly` + UTC midnight subtraction paths.
  - Added regression test proving timestamp `end_date` inputs are normalized to date-only before subtraction:
    - `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F037`.
  - Confirmed `decision_due_date` recalculates from current assignment state when fixed-term `end_date` changes.
  - Added regression coverage:
    - `recomputes fixed-term decision_due_date when end_date changes`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F038`.
  - Confirmed fixed-term `decision_due_date` recalculates when notice period changes.
  - Added regression coverage:
    - `recomputes fixed-term decision_due_date when notice period changes`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F039`.
  - Made `decision_due_date` generation renewal-mode-aware in read normalization:
    - mode `none` suppresses due date generation for non-evergreen entries.
  - Added regression coverage for mode transitions:
    - `recomputes decision_due_date when renewal mode changes between none/manual/auto`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F040`.
  - Confirmed evergreen `decision_due_date` recomputes when anniversary anchor basis changes (start-date basis change).
  - Added deterministic coverage:
    - `recomputes evergreen decision_due_date when anniversary anchor basis changes`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F041`.
  - Added lifecycle suppression in due-date normalization:
    - no `decision_due_date` generation for inactive, terminated, or expired assignment/contract lifecycle state.
  - Included `contract_status` from joined contract reads in shared/clients assignment APIs to enforce lifecycle gating.
  - Added regression test:
    - `skips decision_due_date generation for inactive/terminated assignments`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F042`.
  - Verified suppression path for `renewal_mode = none` when no evergreen anchor is available (e.g. fixed-term assignment) remains enforced.
  - Covered by existing regression test:
    - `recomputes decision_due_date when renewal mode changes between none/manual/auto`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F043`.
  - Added derived per-cycle dedupe key in read normalization:
    - `renewal_cycle_key` (`fixed-term:<end_date>` or `evergreen:<anchor_date>`)
  - Exposed in both shared and clients assignment APIs plus contract interfaces.
  - Added regression coverage:
    - `creates one renewal_cycle_key per computed contract cycle for deduplication`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F044`.
  - Added deterministic dedupe guard for active assignment rows by composite key:
    - `tenant + client_contract_id + renewal_cycle_key`
  - Applied dedupe in list read APIs:
    - `shared/billingClients/clientContracts.ts`
    - `packages/clients/src/models/clientContract.ts`
  - Added regression test:
    - `deduplicates active rows by tenant + client_contract_id + renewal_cycle_key`
    - in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F045`.
  - Added explicit cycle boundary fields in normalization:
    - `renewal_cycle_start`
    - `renewal_cycle_end`
  - Fixed-term boundaries map directly to assignment `start_date`/`end_date`.
  - Evergreen boundaries now use annual cycle bounds helper:
    - `computeEvergreenCycleBounds` in `shared/billingClients/clientContracts.ts`
  - Added deterministic coverage in `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`.
- (2026-02-21) Completed `F046`.
  - Added derived `days_until_due` field to assignment normalization and contract interfaces.
  - New date-only helper:
    - `computeDaysUntilDate` in `shared/billingClients/clientContracts.ts`
  - Added deterministic coverage for positive/negative day deltas and normalized row field presence in:
    - `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F047`.
  - Added clamp bounds to `days_until_due` derivation to preserve overdue visibility while preventing extreme negative/positive corruption:
    - `MAX_ABSOLUTE_DAYS_UNTIL_DUE = 36500`
  - Applied in shared and clients normalization helpers.
  - Added deterministic clamp coverage in:
    - `packages/billing/tests/clientContractEffectiveRenewalSettings.test.ts`
- (2026-02-21) Completed `F048`.
  - Added `renewals` tab value to billing tab union/config metadata in:
    - `packages/billing/src/components/billing-dashboard/billingTabsConfig.ts`
  - Added tab definition (`label=Renewals`, `href=/msp/billing?tab=renewals`) and icon mapping.
  - Added coverage:
    - `packages/billing/tests/billingTabsConfig.renewals.test.ts`
- (2026-02-21) Completed `F049`.
  - Added `Tabs.Content value=\"renewals\"` route to billing dashboard tab host in:
    - `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
  - Added initial placeholder content for the renewals route host.
  - Added route-wiring coverage:
    - `packages/billing/tests/BillingDashboard.renewalsRoute.test.ts`
- (2026-02-21) Completed `F050`.
  - Added dedicated renewals queue page component:
    - `packages/billing/src/components/billing-dashboard/contracts/RenewalsQueueTab.tsx`
  - Updated `BillingDashboard` renewals route to render `<RenewalsQueueTab />`.
  - Added component + wiring coverage:
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
    - `packages/billing/tests/BillingDashboard.renewalsRoute.test.ts`
- (2026-02-21) Completed `F051`.
  - Added server action to load renewal queue rows:
    - `packages/billing/src/actions/renewalsQueueActions.ts`
  - Renewals page now calls `listRenewalQueueRows()` on mount via `useEffect` and renders loading/empty/error/data states.
  - Exported renewals queue actions via:
    - `packages/billing/src/actions/index.ts`
  - Added wiring coverage:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F052`.
  - Added default 90-day horizon behavior to renewals queue loading:
    - `DEFAULT_RENEWALS_HORIZON_DAYS = 90` in `renewalsQueueActions.ts`
    - server-side filtering for `days_until_due` in range `[0, horizonDays]`
  - Updated renewals UI copy to indicate default horizon window.
  - Extended wiring coverage in:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F053`.
  - Added renewals queue bucket quick filters in `RenewalsQueueTab`:
    - `All`, `0-30 Days`, `31-60 Days`, `61-90 Days`
  - Implemented client-side bucket filtering against `days_until_due`.
  - Extended component coverage in:
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F054`.
  - Added owner filter UI + behavior in `RenewalsQueueTab`:
    - owner options derive from queue row `assigned_to` values with `unassigned` fallback.
  - Extended queue row shape from server action with `assigned_to`.
  - Added wiring coverage updates in:
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
- (2026-02-21) Completed `F055`.
  - Added queue status mapping + filter support for:
    - `pending`, `renewing`, `non_renewing`, `snoozed`, `completed`
  - Added status filter UI + filtering behavior in `RenewalsQueueTab`.
  - Extended action/component wiring coverage in:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F056`.
  - Added renewal mode filter support in queue UI for:
    - `none`, `manual`, `auto`
  - Queue row mapping already includes `effective_renewal_mode`; UI filtering now applies this dimension.
  - Extended action/component wiring coverage in:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F057`.
  - Added contract type filter support in queue UI for:
    - `fixed-term`, `evergreen`
  - Filter operates on queue row `contract_type`.
  - Extended component wiring coverage in:
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F058`.
  - Enforced default queue sort by `decision_due_date` ascending in renewals list action.
  - Sorting now occurs after normalization/horizon filtering in:
    - `packages/billing/src/actions/renewalsQueueActions.ts`
  - Added wiring coverage update in:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
- (2026-02-21) Completed `F059`.
  - Added days-remaining visual badge state logic in queue rows:
    - `overdue`, `due-soon`, `upcoming`
  - Rendering now surfaces overdue and due-soon emphasis states via row badge styles.
  - Added component coverage update in:
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F060`.
  - Added `Upcoming Renewals` summary widget to `ClientContractsTab` with queue-derived total count.
  - Widget data source now loads via `listRenewalQueueRows()` during tab fetch flow.
  - Added coverage:
    - `packages/billing/tests/ClientContractsTab.upcomingRenewalsWidget.test.ts`
- (2026-02-21) Completed `F061`.
  - Updated `Upcoming Renewals` widget to display 90-day bucket counts:
    - `0-30`, `31-60`, `61-90`
  - Counts now derive from renewal queue row `days_until_due`.
  - Added coverage update in:
    - `packages/billing/tests/ClientContractsTab.upcomingRenewalsWidget.test.ts`
- (2026-02-21) Completed `F062`.
  - Added widget-to-queue navigation with preserved bucket context in:
    - `packages/billing/src/components/billing-dashboard/contracts/ClientContractsTab.tsx`
  - Bucket count badges now route to:
    - `/msp/billing?tab=renewals&bucket=0-30|31-60|61-90`
  - Added queue hydration from URL bucket query param in:
    - `packages/billing/src/components/billing-dashboard/contracts/RenewalsQueueTab.tsx`
  - Added/updated coverage in:
    - `packages/billing/tests/ClientContractsTab.upcomingRenewalsWidget.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
  - Validation:
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/ClientContractsTab.upcomingRenewalsWidget.test.ts tests/RenewalsQueueTab.component.test.ts`
- (2026-02-21) Completed `F063`.
  - Added queue-to-widget refresh wiring in billing dashboard:
    - `packages/billing/src/components/billing-dashboard/BillingDashboard.tsx`
  - `BillingDashboard` now increments `renewalsQueueRefreshTrigger` when renewals queue refreshes after mutation pathways.
  - Passed refresh trigger into `ClientContractsTab` so upcoming renewals bucket counts are recomputed.
  - `RenewalsQueueTab` now accepts `onQueueMutationComplete` and emits it after successful queue row reloads:
    - `packages/billing/src/components/billing-dashboard/contracts/RenewalsQueueTab.tsx`
  - Added wiring coverage in:
    - `packages/billing/tests/BillingDashboard.renewalsRoute.test.ts`
    - `packages/billing/tests/RenewalsQueueTab.component.test.ts`
  - Validation:
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/BillingDashboard.renewalsRoute.test.ts tests/RenewalsQueueTab.component.test.ts tests/ClientContractsTab.upcomingRenewalsWidget.test.ts`
- (2026-02-21) Completed `F064`.
  - Defined centralized renewal queue status enum in shared contract interfaces:
    - `packages/types/src/interfaces/contract.interfaces.ts`
    - `server/src/interfaces/contract.interfaces.ts`
  - Added renewal work-item interface model (`IClientContractRenewalWorkItem`) with `status: RenewalWorkItemStatus`.
  - Updated queue row model/status normalization to consume `RenewalWorkItemStatus` from shared types:
    - `packages/billing/src/actions/renewalsQueueActions.ts`
  - Updated wiring coverage:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
  - Validation:
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/renewalsQueueActions.wiring.test.ts tests/RenewalsQueueTab.component.test.ts`
    - `npm -w @alga-psa/server run typecheck` (workspace alias not present in root workspaces)
- (2026-02-21) Completed `F065`.
  - Added queue mutation action to transition pending work items to renewing:
    - `markRenewalQueueItemRenewing(clientContractId)` in `packages/billing/src/actions/renewalsQueueActions.ts`
  - Transition behavior:
    - validates required `clientContractId`
    - enforces tenant-scoped active row lookup
    - requires current status to resolve as `pending`
    - updates status to `renewing` and writes `updated_at`
  - Added mutation response payload shape:
    - `RenewalQueueMutationResult`
  - Added/updated wiring coverage:
    - `packages/billing/tests/renewalsQueueActions.wiring.test.ts`
    - `packages/billing/tests/renewalsQueueActions.markRenewing.wiring.test.ts`
  - Validation:
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/renewalsQueueActions.wiring.test.ts tests/renewalsQueueActions.markRenewing.wiring.test.ts`
- (2026-02-21) Completed `F066`.
  - Added queue mutation action to transition pending work items to non-renewing:
    - `markRenewalQueueItemNonRenewing(clientContractId)` in `packages/billing/src/actions/renewalsQueueActions.ts`
  - Transition behavior mirrors mark-renewing safeguards:
    - validates required `clientContractId`
    - verifies status column availability
    - enforces tenant-scoped active row lookup
    - requires current status to resolve as `pending`
    - updates status to `non_renewing` and writes `updated_at`
  - Added wiring coverage:
    - `packages/billing/tests/renewalsQueueActions.markNonRenewing.wiring.test.ts`
  - Validation:
    - `npm -w @alga-psa/billing run typecheck`
    - `npm -w @alga-psa/billing exec vitest run tests/renewalsQueueActions.markRenewing.wiring.test.ts tests/renewalsQueueActions.markNonRenewing.wiring.test.ts`

## Open Questions
- Should renewal ticket defaults be a brand-new billing settings card, or an extension of existing default ticket settings patterns?
- Should evergreen annual review use contract start-date anniversary or configurable anchor date in v1?
- Should renewal status transitions hard-lock contract activation behavior, or remain advisory with warnings in v1?
